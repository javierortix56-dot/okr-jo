<!DOCTYPE html>
<html lang="es" class="bg-slate-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Manager v10.0 | Transfer & Logic Update</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root { --obj: #2563eb; --proj: #7c3aed; --kpi: #f97316; }
        body { font-family: 'Inter', sans-serif; font-size: 13px; color: #1e293b; }
        
        /* ACORDE√ìN (Grid Fix) */
        .accordion-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; overflow: hidden; }
        .accordion-wrapper.open { grid-template-rows: 1fr; }
        .accordion-inner { min-height: 0; }

        /* TARJETAS */
        .card-objective { border-left: 5px solid var(--obj); background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; border-radius: 6px; overflow: hidden; }
        .card-project { border-left: 4px solid var(--proj); background: #fbfbfe; margin: 8px 0 8px 12px; border-radius: 4px; border: 1px solid #e2e8f0; border-left-width: 4px; border-left-color: var(--proj); }
        .card-kpi { border-left: 3px solid var(--kpi); background: white; margin: 4px 0 4px 0; border: 1px solid #f1f5f9; border-left-width: 3px; border-left-color: var(--kpi); }

        /* UI */
        .progress-track { background-color: #e2e8f0; height: 6px; border-radius: 99px; width: 100%; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s ease; }
        .btn-icon { padding: 5px; border-radius: 4px; color: #94a3b8; transition: 0.2s; cursor: pointer; }
        .btn-icon:hover { background: #f1f5f9; color: #334155; }
        .rotate-icon { transition: transform 0.2s; }
        .rotate-90 { transform: rotate(-90deg); }
        
        /* SPINNER */
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #2563eb; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col lg:flex-row overflow-hidden">

    <aside class="w-full lg:w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <div class="h-14 flex items-center px-4 border-b border-slate-100 gap-3">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i data-lucide="target" size="18"></i></div>
            <h1 class="font-bold text-slate-800 text-sm">Famiq OKR <span class="text-xs font-normal text-slate-400">v10.0</span></h1>
        </div>
        <div class="p-4 border-b border-slate-100 bg-slate-50">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">√Årea</label>
            <select id="area-selector" onchange="switchArea(this.value)" class="w-full text-xs p-2 rounded border border-slate-300 font-semibold text-slate-700 outline-none focus:border-blue-500">
                <option value="Oficina T√©cnica">Oficina T√©cnica</option>
                <option value="PXD">PXD</option>
                <option value="Planificaci√≥n">Planificaci√≥n</option>
                <option value="Pricing y Negocio">Pricing y Negocio</option>
            </select>
        </div>
        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <button onclick="switchView('explorer')" class="w-full text-left px-3 py-2 rounded bg-blue-50 text-blue-700 text-xs font-bold flex items-center gap-2"><i data-lucide="layers" size="14"></i> Gesti√≥n OKRs</button>
            <button onclick="switchView('dashboard')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-50 text-slate-500 text-xs font-medium flex items-center gap-2 transition"><i data-lucide="pie-chart" size="14"></i> Reporte</button>
        </nav>
        <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50 text-[10px]">
             <div id="sync-status" class="flex items-center gap-1.5 text-slate-400 font-bold"><span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> Conectando...</div>
             <button onclick="loadFromGoogle()" class="text-blue-600 hover:underline">Reconectar</button>
        </div>
    </aside>

    <main class="flex-1 overflow-hidden flex flex-col relative bg-slate-100">
        <div id="global-loader" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center hidden backdrop-blur-sm"><div class="spinner"></div></div>

        <header class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-6 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="view-title" class="text-sm font-bold text-slate-800">Mis OKRs</h2>
                <span class="text-slate-300">|</span>
                <select id="filter-quarter" onchange="renderExplorer()" class="text-xs font-medium text-slate-500 bg-transparent outline-none cursor-pointer hover:text-blue-600">
                    <option value="ALL">2026 Completo</option>
                    <option value="Q1">Q1 (Ene-Mar)</option>
                    <option value="Q2">Q2 (Abr-Jun)</option>
                    <option value="Q3">Q3 (Jul-Sep)</option>
                    <option value="Q4">Q4 (Oct-Dic)</option>
                </select>
            </div>
            <div class="flex gap-2" id="header-actions">
                <button onclick="toggleAll(false)" class="btn-icon" title="Contraer"><i data-lucide="minimize-2" size="14"></i></button>
                <button onclick="toggleAll(true)" class="btn-icon" title="Expandir"><i data-lucide="maximize-2" size="14"></i></button>
                <button onclick="openModal('objective')" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow-sm text-xs font-bold flex items-center gap-1.5 transition active:scale-95"><i data-lucide="plus" size="14"></i> Nuevo</button>
            </div>
        </header>

        <div id="view-explorer" class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
            <div id="tree-container" class="max-w-5xl mx-auto pb-24 space-y-4"></div>
        </div>

        <div id="view-dashboard" class="hidden flex-1 overflow-y-auto p-6">
            <div class="max-w-6xl mx-auto bg-white rounded shadow-sm border border-slate-200">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-200">
                        <tr><th class="p-3">Item</th><th class="p-3">Fin</th><th class="p-3">Resp.</th><th class="p-3 w-32">Progreso</th><th class="p-3 text-center">Estado</th></tr>
                    </thead>
                    <tbody id="report-body" class="divide-y divide-slate-100 text-xs text-slate-600"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-lg shadow-xl flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 id="modal-title" class="text-xs font-bold text-slate-700 uppercase">Editar</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-rose-500"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="p-5 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-id"><input type="hidden" id="parent-id"><input type="hidden" id="entity-type"><input type="hidden" id="context-type">
                
                <div id="move-wrapper" class="hidden bg-blue-50 p-2.5 rounded border border-blue-100">
                    <label class="block text-[10px] font-bold text-blue-600 uppercase mb-1 flex items-center gap-1"><i data-lucide="corner-up-right" size="10"></i> Mover a otro Objetivo</label>
                    <select id="inp-move-parent" class="w-full text-xs p-1.5 rounded border border-blue-200 outline-none text-slate-700 font-medium"></select>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">T√≠tulo</label>
                    <textarea id="inp-title" rows="2" class="w-full px-3 py-2 text-xs border border-slate-300 rounded focus:border-blue-500 outline-none resize-none font-medium"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Responsable</label><input id="inp-owner" class="w-full px-3 py-2 text-xs border border-slate-300 rounded outline-none"></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Inicio</label><input id="inp-start" type="date" class="w-full px-3 py-2 text-xs border border-slate-300 rounded text-slate-500"></div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Fecha Objetivo (Fin)</label>
                    <div class="flex gap-2">
                        <input id="inp-end" type="date" class="flex-1 px-3 py-2 text-xs border border-slate-300 rounded font-bold text-slate-700 outline-none focus:border-blue-500">
                        <div class="flex border border-slate-200 rounded overflow-hidden flex-shrink-0">
                            <button onclick="setQuarterDate(1)" class="px-2 text-[10px] font-bold text-slate-500 hover:bg-blue-50 hover:text-blue-600 border-r border-slate-100 bg-slate-50">Q1</button>
                            <button onclick="setQuarterDate(2)" class="px-2 text-[10px] font-bold text-slate-500 hover:bg-blue-50 hover:text-blue-600 border-r border-slate-100 bg-slate-50">Q2</button>
                            <button onclick="setQuarterDate(3)" class="px-2 text-[10px] font-bold text-slate-500 hover:bg-blue-50 hover:text-blue-600 border-r border-slate-100 bg-slate-50">Q3</button>
                            <button onclick="setQuarterDate(4)" class="px-2 text-[10px] font-bold text-slate-500 hover:bg-blue-50 hover:text-blue-600 bg-slate-50">Q4</button>
                        </div>
                    </div>
                </div>

                <div id="field-metrics" class="hidden bg-orange-50 p-3 rounded border border-orange-100 grid grid-cols-2 gap-3">
                     <div class="col-span-2 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-orange-600 uppercase flex items-center gap-2"><i data-lucide="hash" size="10"></i> M√©trica KPI</span>
                        <select id="inp-kpi-trend" class="text-[10px] bg-white border border-orange-200 rounded px-1 py-0.5 text-orange-700 font-bold outline-none">
                            <option value="asc">Subir (Incremental)</option>
                            <option value="desc">Bajar (Reducci√≥n)</option>
                        </select>
                     </div>
                     <div><label class="block text-[10px] text-orange-400 mb-1">Base (Inicio)</label><input id="inp-val-start" type="number" class="w-full p-1 text-xs border border-orange-200 rounded text-center font-mono"></div>
                     <div><label class="block text-[10px] text-orange-400 mb-1">Meta (Target)</label><input id="inp-val-target" type="number" class="w-full p-1 text-xs border border-orange-200 rounded text-center font-bold text-orange-700 font-mono"></div>
                </div>
            </div>
            <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex justify-between items-center rounded-b-lg">
                <button id="btn-delete" onclick="deleteItem()" class="text-rose-500 hover:text-rose-700 text-xs font-bold hidden flex items-center gap-1"><i data-lucide="trash-2" size="12"></i> Borrar</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal()" class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded">Cancelar</button>
                    <button onclick="saveData()" class="px-4 py-1.5 text-xs font-bold bg-blue-600 text-white rounded shadow hover:bg-blue-700">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-weights" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-lg shadow-2xl flex flex-col animate-[fadeIn_0.2s_ease-out]">
            <div class="px-5 py-4 border-b border-slate-100">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2"><i data-lucide="scale" size="16" class="text-blue-600"></i> Balancear Pesos (Incidencia)</h3>
                <p class="text-[11px] text-slate-400 mt-1">La suma debe ser exactamente 100%.</p>
            </div>
            <div class="p-5 overflow-y-auto max-h-[60vh]">
                <input type="hidden" id="weight-obj-id">
                <div id="weight-list" class="space-y-3"></div>
            </div>
            <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex justify-between items-center rounded-b-lg">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500">Total:</span>
                    <span id="weight-total-display" class="text-sm font-bold text-slate-800">0%</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-weights').classList.add('hidden')" class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded">Cancelar</button>
                    <button id="btn-save-weights" onclick="saveWeights()" class="px-4 py-1.5 text-xs font-bold bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Guardar Balance</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE CONEXI√ìN RESTAURADA
        let API_URL = localStorage.getItem('okr_api_url') || 'https://script.google.com/macros/s/AKfycbwvqc8WF33hbifl43JwMFGp1PH-ubndf7PT4cZhn3XPBR5jUoHoEEPoVBOPVje_MbE7hw/exec';
        let CURRENT_AREA = localStorage.getItem('okr_current_area') || 'Oficina T√©cnica';
        let db = { objectives: [], projects: [], kpis: [], tasks: [] };
        
        // INIT
        document.getElementById('area-selector').value = CURRENT_AREA;
        loadFromGoogle(); 

        // --- CORE FUNCTIONS ---
        async function loadFromGoogle() {
            toggleLoader(true);
            const btn = document.getElementById('sync-status');
            btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span> Cargando...';
            try {
                const res = await fetch(API_URL);
                db = await res.json();
                renderExplorer();
                btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Online';
            } catch(e) { 
                console.error(e); 
                btn.innerHTML = '<span class="text-rose-500 font-bold">Error Conexi√≥n</span>';
            } finally { toggleLoader(false); }
        }

        async function saveToGoogle() {
            if(!API_URL) return;
            const btn = document.getElementById('sync-status');
            btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span> Guardando...';
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(db) });
                setTimeout(()=> btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Online', 1000);
            } catch(e) { btn.innerHTML = '<span class="text-rose-500">Error Guardado</span>'; }
        }

        // --- C√ÅLCULO PONDERADO MEJORADO ---
        function calculateProgress(item, type) {
            if (type === 'kpi') {
                const s = parseFloat(item.startValue)||0, t = parseFloat(item.targetValue)||0, c = parseFloat(item.currentValue!==undefined ? item.currentValue : s);
                
                // L√≥gica "Bajar / Mantener por debajo" autom√°tica basada en valores
                // Si Target < Start, asumimos que "menos es mejor"
                if (s === t) return c >= t ? 100 : 0; // Edge case
                
                // Calculo universal de distancia
                let p = t > s 
                    ? ((c - s) / (t - s)) * 100   // Incremental (0 -> 100)
                    : ((s - c) / (s - t)) * 100;  // Decremental (100 -> 0)
                
                return Math.max(0, Math.min(100, Math.round(p)));
            }
            
            let children = [];
            if (type === 'objective') {
                db.kpis.filter(k => k.objectiveId === item.id && !k.projectId).forEach(k => children.push({p: calculateProgress(k,'kpi'), w: parseFloat(k.weight)||0}));
                db.projects.filter(p => p.objectiveId === item.id).forEach(p => children.push({p: calculateProgress(p,'project'), w: parseFloat(p.weight)||0}));
            } else if (type === 'project') {
                db.kpis.filter(k => k.projectId === item.id).forEach(k => children.push({p: calculateProgress(k,'kpi'), w: parseFloat(k.weight)||0}));
                db.tasks.filter(t => t.projectId === item.id).forEach(t => children.push({p: t.done?100:0, w: 1}));
            }

            if (!children.length) return 0;
            const totalWeight = children.reduce((acc, x) => acc + x.w, 0);
            if (totalWeight === 0) return Math.round(children.reduce((acc,x)=>acc+x.p,0) / children.length);
            const weightedSum = children.reduce((acc, x) => acc + (x.p * (x.w / totalWeight)), 0);
            return Math.round(weightedSum);
        }

        // --- RENDER ---
        function renderExplorer() {
            const container = document.getElementById('tree-container'); container.innerHTML = '';
            const q = document.getElementById('filter-quarter').value;
            
            const objs = db.objectives.filter(o => {
                if((o.area||'Oficina T√©cnica') !== CURRENT_AREA) return false;
                if(q==='ALL') return true;
                const m = new Date(o.endDate).getMonth()+1;
                return q==='Q1'?m<=3 : q==='Q2'?m>3&&m<=6 : q==='Q3'?m>6&&m<=9 : m>9;
            });

            if(!objs.length) { container.innerHTML='<div class="text-center text-slate-400 py-10 opacity-60 flex flex-col items-center"><i data-lucide="ghost" size="32" class="mb-2"></i>Sin objetivos para este periodo</div>'; lucide.createIcons(); return; }

            objs.forEach(obj => {
                const prog = calculateProgress(obj, 'objective');
                const barColor = prog>=100?'bg-emerald-500':prog>=50?'bg-blue-500':'bg-amber-400';
                
                let childrenHTML = '';
                db.kpis.filter(k=>k.objectiveId===obj.id && !k.projectId).forEach(k=> childrenHTML+=renderKpiRow(k));
                db.projects.filter(p=>p.objectiveId===obj.id).forEach(p=> childrenHTML+=renderProjectRow(p));

                container.innerHTML += `
                <div class="card-objective group">
                    <div class="p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition relative z-10 bg-white" onclick="toggleAccordion('obj-${obj.id}', 'icon-o-${obj.id}')">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <i id="icon-o-${obj.id}" data-lucide="chevron-down" class="text-slate-300 rotate-icon"></i>
                            <div>
                                <h3 class="font-bold text-slate-800 leading-tight truncate pr-2">${obj.title}</h3>
                                <div class="text-[10px] text-slate-400 mt-0.5 font-mono">${obj.endDate} ¬∑ ${obj.owner||'S/A'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 pl-4">
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                <button onclick="event.stopPropagation(); openEdit('objective', ${obj.id})" class="btn-icon" title="Editar"><i data-lucide="pencil" size="14"></i></button>
                                <button onclick="event.stopPropagation(); openWeightModal(${obj.id})" class="btn-icon text-purple-500" title="Ponderaci√≥n"><i data-lucide="scale" size="14"></i></button>
                            </div>
                            <div class="w-20 text-right">
                                <div class="text-xs font-bold text-slate-700 mb-1">${prog}%</div>
                                <div class="progress-track h-1.5"><div class="progress-bar ${barColor}" style="width:${prog}%"></div></div>
                            </div>
                        </div>
                    </div>
                    <div id="obj-${obj.id}" class="accordion-wrapper open">
                        <div class="accordion-inner border-t border-slate-100 bg-white">
                            <div class="p-2 pl-4 pr-2">
                                <div class="flex justify-end gap-2 mb-2">
                                    <button onclick="openModal('project',${obj.id})" class="text-[10px] font-bold text-slate-400 hover:text-blue-600 flex gap-1 items-center px-2 py-1 bg-slate-50 rounded border border-slate-100 transition"><i data-lucide="folder-plus" size="12"></i> Proyecto</button>
                                    <button onclick="openModal('kpi',${obj.id},'objective')" class="text-[10px] font-bold text-slate-400 hover:text-orange-600 flex gap-1 items-center px-2 py-1 bg-slate-50 rounded border border-slate-100 transition"><i data-lucide="bar-chart" size="12"></i> KPI</button>
                                </div>
                                ${childrenHTML || '<div class="text-[10px] italic text-slate-300 py-2">Sin contenido.</div>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        }

        function renderProjectRow(p) {
            const prog = calculateProgress(p, 'project');
            let innerHTML = '';
            db.tasks.filter(t=>t.projectId===p.id).forEach(t=> innerHTML+=`
                <div class="flex items-center gap-2 py-1 hover:bg-white rounded px-2 group/task">
                    <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" class="cursor-pointer rounded border-slate-300 text-blue-600">
                    <span class="text-xs text-slate-600 flex-1 truncate ${t.done?'line-through opacity-50':''}">${t.title}</span>
                    <button onclick="delTask(${t.id})" class="opacity-0 group-hover/task:opacity-100 text-rose-400 hover:text-rose-600"><i data-lucide="x" size="12"></i></button>
                </div>
            `);
            innerHTML += `<input type="text" placeholder="+ Tarea..." class="w-full text-xs bg-transparent border-b border-transparent focus:border-slate-300 outline-none mt-1 px-2 py-1 placeholder:text-slate-300" onkeydown="if(event.key==='Enter'){addTask(${p.id},this.value);this.value=''}">`;
            db.kpis.filter(k=>k.projectId===p.id).forEach(k=> innerHTML+=renderKpiRow(k));

            return `
            <div class="card-project group/proj">
                <div class="p-2 flex items-center justify-between cursor-pointer" onclick="toggleAccordion('proj-${p.id}', 'icon-p-${p.id}')">
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <i id="icon-p-${p.id}" data-lucide="chevron-right" size="14" class="text-slate-400 rotate-icon ${p.isCollapsed?'':'rotate-90'}"></i>
                        <span class="text-xs font-semibold text-slate-700 truncate">${p.title}</span>
                        ${p.weight>0 ? `<span class="text-[9px] bg-purple-100 text-purple-700 px-1 rounded">${p.weight}%</span>`:''}
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="opacity-0 group-hover/proj:opacity-100 flex gap-1">
                            <button onclick="event.stopPropagation(); openEdit('project',${p.id})" class="btn-icon"><i data-lucide="pencil" size="12"></i></button>
                            <button onclick="event.stopPropagation(); openModal('kpi',${p.id},'project')" class="btn-icon text-orange-400"><i data-lucide="bar-chart" size="12"></i></button>
                        </div>
                        <span class="text-[10px] font-bold text-slate-500 w-8 text-right">${prog}%</span>
                    </div>
                </div>
                <div id="proj-${p.id}" class="accordion-wrapper ${p.isCollapsed?'':'open'}">
                    <div class="accordion-inner pl-6 pr-2 pb-2">
                        ${innerHTML}
                    </div>
                </div>
            </div>`;
        }

        function renderKpiRow(k) {
            const prog = calculateProgress(k, 'kpi');
            // Detectar tendencia visualmente
            const isDesc = parseFloat(k.targetValue) < parseFloat(k.startValue);
            return `
            <div class="card-kpi flex items-center justify-between p-1.5 pl-2 group/kpi hover:shadow-sm transition">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                    <span class="text-[9px] font-bold text-orange-500 bg-orange-50 px-1 rounded border border-orange-100">KPI</span>
                    <span class="text-xs text-slate-700 truncate cursor-pointer hover:text-orange-600" onclick="openEdit('kpi',${k.id})">${k.title}</span>
                    ${isDesc ? '<span class="text-[8px] text-rose-400 bg-rose-50 px-1 rounded">‚ñº</span>' : ''}
                    ${k.weight>0 ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded">${k.weight}%</span>`:''}
                </div>
                <div class="flex items-center gap-2">
                    <input type="number" value="${k.currentValue}" onchange="updateKpiVal(${k.id},this.value)" class="w-12 text-center text-xs border-b border-slate-200 bg-transparent focus:border-orange-400 outline-none font-mono">
                    <span class="text-[10px] text-slate-400">/ ${k.targetValue}</span>
                    <div class="w-10 h-1 bg-slate-100 rounded overflow-hidden ml-1"><div class="h-full bg-orange-400" style="width:${prog}%"></div></div>
                </div>
            </div>`;
        }

        // --- GESTI√ìN DE PESOS ---
        function openWeightModal(objId) {
            const modal = document.getElementById('modal-weights');
            const list = document.getElementById('weight-list');
            document.getElementById('weight-obj-id').value = objId;
            list.innerHTML = '';
            modal.classList.remove('hidden');

            const children = [
                ...db.projects.filter(p => p.objectiveId === objId).map(p => ({...p, type:'PROY'})),
                ...db.kpis.filter(k => k.objectiveId === objId && !k.projectId).map(k => ({...k, type:'KPI'}))
            ];

            if(!children.length) { list.innerHTML = '<div class="text-slate-400 text-center text-xs">Agrega proyectos o KPIs primero.</div>'; updateTotalWeight(); return; }

            children.forEach(c => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-3 bg-slate-50 p-2 rounded border border-slate-200";
                row.innerHTML = `
                    <span class="text-[9px] font-bold px-1 rounded ${c.type==='PROY'?'bg-purple-100 text-purple-700':'bg-orange-100 text-orange-700'} w-10 text-center">${c.type}</span>
                    <span class="text-xs text-slate-700 flex-1 truncate">${c.title}</span>
                    <input type="range" min="0" max="100" value="${c.weight||0}" step="0.5" class="w-24 accent-blue-600" oninput="this.nextElementSibling.value=parseFloat(this.value)+'%'; updateTotalWeight()">
                    <input type="text" value="${parseFloat(c.weight||0)}%" class="w-12 text-right text-xs font-bold bg-transparent outline-none" readonly>
                    <input type="hidden" class="item-id" value="${c.id}"><input type="hidden" class="item-type" value="${c.type}">
                `;
                list.appendChild(row);
            });
            updateTotalWeight();
        }

        function updateTotalWeight() {
            const inputs = document.querySelectorAll('#weight-list input[type="range"]');
            let sum = 0;
            inputs.forEach(i => sum += parseFloat(i.value));
            sum = Math.round(sum * 10) / 10;
            
            const display = document.getElementById('weight-total-display');
            const btn = document.getElementById('btn-save-weights');
            
            display.innerText = sum + "%";
            if(sum === 100) { display.className="text-emerald-600 font-bold text-sm"; btn.disabled=false; btn.classList.remove('opacity-50','cursor-not-allowed'); }
            else { display.className="text-rose-500 font-bold text-sm"; btn.disabled=true; btn.classList.add('opacity-50','cursor-not-allowed'); }
        }

        function saveWeights() {
            const rows = document.querySelectorAll('#weight-list > div');
            rows.forEach(r => {
                const id = parseInt(r.querySelector('.item-id').value);
                const type = r.querySelector('.item-type').value;
                const val = parseFloat(r.querySelector('input[type="range"]').value);
                if(type==='PROY') { const p = db.projects.find(x=>x.id===id); if(p) p.weight = val; }
                else { const k = db.kpis.find(x=>x.id===id); if(k) k.weight = val; }
            });
            saveToGoogle();
            document.getElementById('modal-weights').classList.add('hidden');
            renderExplorer();
        }

        // --- ACTIONS ---
        function setQuarterDate(q) {
            const year = "2026";
            const dates = { 1: "-03-31", 2: "-06-30", 3: "-09-30", 4: "-12-31" };
            document.getElementById('inp-end').value = year + dates[q];
        }

        function toggleAccordion(id, iconId) {
            document.getElementById(id).classList.toggle('open');
            document.getElementById(iconId).classList.toggle('rotate-90');
            if(id.includes('proj-')) {
                const pid = parseInt(id.split('-')[1]);
                const p = db.projects.find(x=>x.id===pid);
                if(p) p.isCollapsed = !document.getElementById(id).classList.contains('open');
            }
        }

        function openModal(type, pid, ctx) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('entity-type').value=type; 
            document.getElementById('parent-id').value=pid||''; 
            document.getElementById('context-type').value=ctx||'';
            document.getElementById('edit-id').value='';
            document.getElementById('modal-title').innerText = "Nuevo " + (type==='objective'?'Objetivo':type==='project'?'Proyecto':'KPI');
            document.getElementById('field-metrics').classList.toggle('hidden', type!=='kpi');
            
            // Ocultar opci√≥n de mover en creaci√≥n nueva
            document.getElementById('move-wrapper').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden');

            ['inp-title','inp-owner','inp-start','inp-end','inp-val-start','inp-val-target'].forEach(i=>document.getElementById(i).value='');
        }

        function openEdit(type, id) {
            const i = (type==='objective'?db.objectives:type==='project'?db.projects:db.kpis).find(x=>x.id===id);
            if(!i)return;
            
            openModal(type, null, null);
            document.getElementById('edit-id').value = id;
            document.getElementById('btn-delete').classList.remove('hidden');
            
            // POBLAR DATOS B√ÅSICOS
            document.getElementById('inp-title').value = i.title;
            document.getElementById('inp-owner').value = i.owner||'';
            document.getElementById('inp-start').value = i.startDate;
            document.getElementById('inp-end').value = i.endDate;

            // LOGICA MOVER (Transferencia)
            const moveWrapper = document.getElementById('move-wrapper');
            const moveSelect = document.getElementById('inp-move-parent');
            moveWrapper.classList.add('hidden');
            
            if(type === 'project' || (type === 'kpi' && i.objectiveId && !i.projectId)) {
                // Si es Proyecto o KPI de Objetivo -> Listar Objetivos
                const potentialParents = db.objectives.filter(o => (o.area||'Oficina T√©cnica') === CURRENT_AREA);
                if(potentialParents.length > 0) {
                    moveSelect.innerHTML = potentialParents.map(p => `<option value="${p.id}" ${p.id === i.objectiveId ? 'selected' : ''}>${p.title}</option>`).join('');
                    moveWrapper.classList.remove('hidden');
                }
            } 
            // Podr√≠amos agregar l√≥gica para mover KPI de proyecto a otro proyecto, pero la solicitud dec√≠a "de un objetivo a otro".

            // LOGICA KPI
            if(type==='kpi'){
                document.getElementById('inp-val-start').value = i.startValue;
                document.getElementById('inp-val-target').value = i.targetValue;
                // Auto-detectar tendencia para mostrar en selector
                const isDesc = parseFloat(i.targetValue) < parseFloat(i.startValue);
                document.getElementById('inp-kpi-trend').value = isDesc ? 'desc' : 'asc';
            }
        }

        function saveData() {
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('entity-type').value;
            const pid = parseInt(document.getElementById('parent-id').value);
            
            const data = {
                title: document.getElementById('inp-title').value,
                owner: document.getElementById('inp-owner').value,
                startDate: document.getElementById('inp-start').value,
                endDate: document.getElementById('inp-end').value
            };

            if(id) { // UPDATE
                const list = type==='objective'?db.objectives:type==='project'?db.projects:db.kpis;
                const idx = list.findIndex(x=>x.id==id);
                if(idx!==-1) {
                    list[idx] = {...list[idx], ...data};
                    
                    // PROCESAR KPI
                    if(type==='kpi'){
                        list[idx].startValue = document.getElementById('inp-val-start').value;
                        list[idx].targetValue = document.getElementById('inp-val-target').value;
                        // Forzar consistencia visual si el usuario eligi√≥ bajar
                        // (No cambiamos el c√≥digo matem√°tico, solo aseguramos que la meta tenga sentido si lo desean)
                    }

                    // PROCESAR MOVER
                    const moveWrapper = document.getElementById('move-wrapper');
                    if(!moveWrapper.classList.contains('hidden')) {
                        const newParentId = parseInt(document.getElementById('inp-move-parent').value);
                        if(type === 'project' && list[idx].objectiveId !== newParentId) {
                            list[idx].objectiveId = newParentId;
                        }
                        if(type === 'kpi' && list[idx].objectiveId && list[idx].objectiveId !== newParentId) {
                            list[idx].objectiveId = newParentId;
                        }
                    }
                }
            } else { // CREATE
                const newItem = { id: Date.now(), ...data, weight: 0 }; 
                if(type==='objective'){ newItem.area=CURRENT_AREA; db.objectives.push(newItem); }
                else if(type==='project'){ newItem.objectiveId=pid; newItem.isCollapsed=false; db.projects.push(newItem); }
                else { 
                    newItem.startValue=document.getElementById('inp-val-start').value; 
                    newItem.targetValue=document.getElementById('inp-val-target').value; 
                    newItem.currentValue=newItem.startValue;
                    if(document.getElementById('context-type').value==='objective') newItem.objectiveId=pid; else newItem.projectId=pid;
                    db.kpis.push(newItem);
                }
            }
            saveToGoogle(); closeModal(); renderExplorer();
        }

        function deleteItem(){
             const id=parseInt(document.getElementById('edit-id').value);
             const type=document.getElementById('entity-type').value;
             if(!confirm('¬øEliminar?'))return;
             if(type==='objective'){ db.objectives=db.objectives.filter(x=>x.id!==id); db.projects=db.projects.filter(x=>x.objectiveId!==id); db.kpis=db.kpis.filter(x=>x.objectiveId!==id); }
             else if(type==='project'){ db.projects=db.projects.filter(x=>x.id!==id); db.tasks=db.tasks.filter(x=>x.projectId!==id); db.kpis=db.kpis.filter(x=>x.projectId!==id); }
             else { db.kpis=db.kpis.filter(x=>x.id!==id); }
             saveToGoogle(); closeModal(); renderExplorer();
        }
        
        function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }
        function toggleTask(id) { const t=db.tasks.find(x=>x.id===id); if(t){ t.done=!t.done; saveToGoogle(); renderExplorer(); }}
        function updateKpiVal(id,v){ const k=db.kpis.find(x=>x.id===id); if(k){ k.currentValue=v; saveToGoogle(); renderExplorer(); }}
        function addTask(pid,t){ if(t.trim()){ db.tasks.push({id:Date.now(), projectId:pid, title:t, done:false}); saveToGoogle(); renderExplorer(); }}
        function delTask(id){ if(confirm('¬øBorrar tarea?')){ db.tasks=db.tasks.filter(t=>t.id!==id); saveToGoogle(); renderExplorer(); }}
        function switchArea(a){ CURRENT_AREA=a; localStorage.setItem('okr_current_area',a); renderExplorer(); }
        function switchView(v){ 
            document.getElementById('view-explorer').classList.toggle('hidden', v!=='explorer');
            document.getElementById('view-dashboard').classList.toggle('hidden', v!=='dashboard');
            document.getElementById('header-actions').classList.toggle('hidden', v==='dashboard');
            if(v==='dashboard') renderDashboard();
        }
        function toggleLoader(s){ document.getElementById('global-loader').classList.toggle('hidden', !s); }
        function toggleAll(exp){ document.querySelectorAll('.accordion-wrapper').forEach(e=> exp?e.classList.add('open'):e.classList.remove('open')); }
        function renderDashboard() {
            const b=document.getElementById('report-body'); b.innerHTML='';
            db.objectives.filter(o=>(o.area||'Oficina T√©cnica')===CURRENT_AREA).forEach(o=>{
                const p=calculateProgress(o,'objective');
                b.innerHTML+=`<tr><td class="p-3 font-semibold">${o.title}</td><td class="p-3 text-slate-400">${o.endDate}</td><td class="p-3">${o.owner||'-'}</td><td class="p-3 text-blue-600 font-bold">${p}%</td><td class="p-3 text-center">${p>=100?'‚úÖ':'üîÑ'}</td></tr>`;
            });
        }
    </script>
</body>
</html>
