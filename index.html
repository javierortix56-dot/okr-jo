<!DOCTYPE html>
<html lang="es" class="bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Manager v9.0 | Cascade & UI Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root { 
            --obj-color: #2563eb; /* Azul */
            --proj-color: #7c3aed; /* Violeta */
            --kpi-color: #f97316; /* Naranja */
        }
        body { font-family: 'Inter', sans-serif; font-size: 13px; color: #1e293b; }
        
        /* Sistema de Tarjetas Jerárquicas */
        .card-objective { border-left: 4px solid var(--obj-color); background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; border-radius: 0 8px 8px 0; }
        .card-project { border-left: 4px solid var(--proj-color); background: #f5f3ff; margin-top: 0.5rem; margin-bottom: 0.5rem; margin-left: 1rem; border-radius: 0 6px 6px 0; border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        .card-kpi { border-left: 4px solid var(--kpi-color); background: white; margin-left: 0.5rem; border: 1px solid #e2e8f0; border-left-width: 4px; border-left-color: var(--kpi-color); }

        /* Componentes UI */
        .progress-track { background-color: #e2e8f0; overflow: hidden; height: 6px; border-radius: 3px; width: 80px; position: relative; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        
        /* Acordeón (Sin overflow hidden en el padre para evitar cortar popups, usamos grid) */
        .accordion-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; }
        .accordion-content.open { grid-template-rows: 1fr; }
        .accordion-inner { overflow: hidden; }

        /* Botones y Acciones */
        .btn-icon { padding: 4px; border-radius: 4px; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .btn-icon:hover { background: #e2e8f0; color: #334155; }
        .rotate-icon { transition: transform 0.2s; }
        .rotate-90 { transform: rotate(-90deg); }

        /* Inputs Integrados */
        .inline-input { background: transparent; border-bottom: 1px solid #cbd5e1; font-family: monospace; text-align: center; width: 50px; outline: none; }
        .inline-input:focus { border-color: #3b82f6; }

        /* Chips */
        .badge-type { font-size: 9px; font-weight: 800; padding: 1px 4px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-obj { color: var(--obj-color); background: #eff6ff; }
        .badge-proj { color: var(--proj-color); background: #f5f3ff; }
        .badge-kpi { color: var(--kpi-color); background: #fff7ed; }
        
        /* Loader */
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col lg:flex-row overflow-hidden">

    <aside class="w-full lg:w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <div class="h-14 flex items-center px-4 border-b border-slate-100 gap-3">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i data-lucide="target" size="18"></i></div>
            <div>
                <h1 class="font-bold text-slate-800 text-sm">Famiq OKR</h1>
                <span class="text-[10px] text-slate-400 font-medium">Oficina Técnica</span>
            </div>
        </div>
        
        <div class="p-4 border-b border-slate-100 bg-slate-50">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Área de Gestión</label>
            <select id="area-selector" onchange="switchArea(this.value)" class="w-full text-xs p-2 rounded border border-slate-300 font-semibold text-slate-700 focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="Oficina Técnica">Oficina Técnica</option>
                <option value="PXD">PXD</option>
                <option value="Planificación">Planificación</option>
                <option value="Pricing y Negocio">Pricing y Negocio</option>
            </select>
        </div>

        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <button onclick="switchView('explorer')" class="w-full text-left px-3 py-2 rounded-md bg-blue-50 text-blue-700 text-xs font-bold flex items-center gap-2">
                <i data-lucide="layers" size="14"></i> Gestión de OKRs
            </button>
            <button onclick="switchView('dashboard')" class="w-full text-left px-3 py-2 rounded-md hover:bg-slate-50 text-slate-500 text-xs font-medium flex items-center gap-2 transition">
                <i data-lucide="pie-chart" size="14"></i> Reporte & Status
            </button>
        </nav>
        
        <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50">
             <div id="sync-status" class="flex items-center gap-1.5 text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded border border-emerald-100">
                 <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Online
             </div>
             <button onclick="saveToGoogle()" class="text-[10px] text-blue-600 hover:underline">Forzar Sync</button>
        </div>
    </aside>

    <main class="flex-1 overflow-hidden flex flex-col relative bg-slate-100/50">
        
        <div id="global-loader" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm hidden">
            <div class="flex flex-col items-center gap-2">
                <div class="spinner"></div>
                <span class="text-xs font-bold text-slate-500">Sincronizando...</span>
            </div>
        </div>

        <header class="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-6 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="view-title" class="text-sm font-bold text-slate-800">Mis OKRs 2026</h2>
                <div class="h-4 w-[1px] bg-slate-300"></div>
                <select id="filter-quarter" onchange="renderExplorer()" class="text-xs font-medium text-slate-500 bg-transparent outline-none cursor-pointer hover:text-blue-600">
                    <option value="ALL">Todo el Año</option>
                    <option value="Q1">Q1 (Ene-Mar)</option>
                    <option value="Q2">Q2 (Abr-Jun)</option>
                    <option value="Q3">Q3 (Jul-Sep)</option>
                    <option value="Q4">Q4 (Oct-Dic)</option>
                </select>
            </div>
            <div id="header-actions" class="flex gap-2">
                <button onclick="toggleAll(false)" class="btn-icon" title="Contraer todo"><i data-lucide="minimize-2" size="14"></i></button>
                <button onclick="toggleAll(true)" class="btn-icon" title="Expandir todo"><i data-lucide="maximize-2" size="14"></i></button>
                <button onclick="openModal('objective')" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow-sm text-xs font-bold flex items-center gap-1.5 transition active:scale-95">
                    <i data-lucide="plus" size="14"></i> Nuevo Objetivo
                </button>
            </div>
        </header>

        <div id="view-explorer" class="flex-1 overflow-y-auto p-4 lg:p-6 scroll-smooth">
            <div id="tree-container" class="max-w-5xl mx-auto pb-20"></div>
        </div>

        <div id="view-dashboard" class="hidden flex-1 overflow-y-auto p-6">
            <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700">Resumen Ejecutivo</h3>
                    <button onclick="exportCSV()" class="text-blue-600 text-xs font-bold hover:underline flex items-center gap-1"><i data-lucide="download" size="12"></i> Exportar CSV</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="p-3 pl-4">Objetivo / Proyecto</th>
                                <th class="p-3">Responsable</th>
                                <th class="p-3">Fecha Fin</th>
                                <th class="p-3 w-32">Progreso</th>
                                <th class="p-3 text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="report-body" class="divide-y divide-slate-100 text-xs text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-lg shadow-2xl flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 id="modal-title" class="text-xs font-bold text-slate-700 uppercase tracking-wide">Editar</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-rose-500"><i data-lucide="x" size="18"></i></button>
            </div>
            
            <div class="p-5 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-id"><input type="hidden" id="parent-id"><input type="hidden" id="entity-type"><input type="hidden" id="context-type">
                
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Título</label>
                    <textarea id="inp-title" rows="2" class="w-full px-3 py-2 text-xs border border-slate-300 rounded focus:border-blue-500 outline-none resize-none font-medium"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Responsable</label>
                        <input id="inp-owner" type="text" class="w-full px-3 py-2 text-xs border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="Ej: Juan Perez">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Peso (Importancia)</label>
                        <input id="inp-weight" type="number" class="w-full px-3 py-2 text-xs border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="1 a 10">
                    </div>
                </div>
                
                <div id="owner-suggestions" class="flex flex-wrap gap-1 empty:hidden"></div>

                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-3 rounded border border-slate-100">
                    <div><label class="block text-[10px] text-slate-400 mb-1">Inicio</label><input id="inp-start" type="date" class="w-full p-1.5 text-xs border border-slate-200 rounded bg-white"></div>
                    <div><label class="block text-[10px] text-slate-400 mb-1">Vencimiento</label><input id="inp-end" type="date" class="w-full p-1.5 text-xs border border-slate-200 rounded bg-white font-bold text-slate-700"></div>
                </div>

                 <div id="field-metrics" class="hidden bg-orange-50 p-3 rounded border border-orange-100 grid grid-cols-2 gap-3">
                     <div class="col-span-2 text-[10px] font-bold text-orange-600 uppercase flex items-center gap-2"><i data-lucide="hash" size="10"></i> Configuración Numérica KPI</div>
                     <div><label class="block text-[10px] text-orange-400 mb-1">Valor Inicial</label><input id="inp-val-start" type="number" class="w-full p-1.5 text-xs border border-orange-200 rounded text-center font-mono"></div>
                     <div><label class="block text-[10px] text-orange-400 mb-1">Meta Objetivo</label><input id="inp-val-target" type="number" class="w-full p-1.5 text-xs border border-orange-200 rounded text-center font-bold text-orange-700 font-mono"></div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Etiquetas (Opcional)</label>
                    <input id="inp-tags" type="text" class="w-full px-3 py-2 text-xs border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="Ej: Q1, Urgente">
                </div>
            </div>

            <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex justify-between items-center rounded-b-lg">
                <button id="btn-delete" onclick="deleteItemFromModal()" class="text-rose-500 hover:text-rose-700 text-xs font-bold hidden flex items-center gap-1"><i data-lucide="trash-2" size="12"></i> Eliminar</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal()" class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded transition">Cancelar</button>
                    <button onclick="saveDataFromModal()" class="px-4 py-1.5 text-xs font-bold bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition transform active:scale-95">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN Y ESTADO
        let API_URL = localStorage.getItem('okr_api_url') || 'https://script.google.com/macros/s/AKfycbwvqc8WF33hbifl43JwMFGp1PH-ubndf7PT4cZhn3XPBR5jUoHoEEPoVBOPVje_MbE7hw/exec';
        let CURRENT_AREA = localStorage.getItem('okr_current_area') || 'Oficina Técnica';
        let db = { objectives: [], projects: [], kpis: [], tasks: [] };
        let recentOwners = JSON.parse(localStorage.getItem('okr_recent_owners')) || [];

        // INIT
        document.getElementById('area-selector').value = CURRENT_AREA;
        if(API_URL) loadFromGoogle(); else renderExplorer();

        // ---------------------------------------------------------
        // LOGICA DE DATOS Y SINCRONIZACIÓN
        // ---------------------------------------------------------
        async function loadFromGoogle() {
            toggleLoader(true);
            try {
                const res = await fetch(API_URL);
                db = await res.json();
                renderExplorer(); // Renderizar inmediatamente después de cargar
            } catch(e) { 
                console.error("Error cargando datos", e); 
                document.getElementById('sync-status').innerHTML = '<span class="text-rose-500 font-bold">Error Sync</span>';
            } finally { toggleLoader(false); }
        }

        async function saveToGoogle() {
            const btn = document.getElementById('sync-status');
            btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span> Guardando...';
            try {
                // Modo no-cors para Google Scripts simples
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(db) });
                setTimeout(() => {
                    btn.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Online';
                }, 1000);
            } catch(e) { btn.innerHTML = '<span class="text-rose-500">Error Guardado</span>'; }
        }

        // ---------------------------------------------------------
        // MOTOR DE CÁLCULO (CASCADA REAL)
        // ---------------------------------------------------------
        function calculateProgress(item, type) {
            // 1. Si es KPI, cálculo directo valor vs meta
            if (type === 'kpi') {
                const start = parseFloat(item.startValue) || 0;
                const target = parseFloat(item.targetValue) || 100;
                const current = (item.currentValue !== undefined && item.currentValue !== "") ? parseFloat(item.currentValue) : start;
                
                if (target === start) return (current >= target) ? 100 : 0;
                
                let percent = 0;
                if (target > start) percent = ((current - start) / (target - start)) * 100;
                else percent = ((start - current) / (start - target)) * 100; // Meta decreciente (ej: reducir errores)
                
                return Math.max(0, Math.min(100, Math.round(percent)));
            }

            // 2. Si es Contenedor (Objetivo o Proyecto), suma ponderada de hijos
            let children = [];
            
            // Recolectar hijos directos
            if (type === 'objective') {
                // KPIs directos del objetivo
                db.kpis.filter(k => k.objectiveId === item.id && !k.projectId)
                       .forEach(k => children.push({ p: calculateProgress(k, 'kpi'), w: parseFloat(k.weight) || 1 }));
                // Proyectos del objetivo
                db.projects.filter(p => p.objectiveId === item.id)
                           .forEach(p => children.push({ p: calculateProgress(p, 'project'), w: parseFloat(p.weight) || 1 }));
            }
            
            if (type === 'project') {
                // KPIs del proyecto
                db.kpis.filter(k => k.projectId === item.id)
                       .forEach(k => children.push({ p: calculateProgress(k, 'kpi'), w: parseFloat(k.weight) || 1 }));
                // Tareas del proyecto (Binario: 0 o 100)
                db.tasks.filter(t => t.projectId === item.id)
                        .forEach(t => children.push({ p: t.done ? 100 : 0, w: 1 })); // Las tareas pesan 1 por defecto
            }

            // Si no hay hijos, progreso es 0
            if (children.length === 0) return 0;

            // Promedio ponderado
            const totalWeight = children.reduce((sum, child) => sum + child.w, 0);
            const totalProgress = children.reduce((sum, child) => sum + (child.p * child.w), 0);
            
            return Math.round(totalProgress / totalWeight);
        }

        // Función para determinar el color de la barra según progreso
        function getProgressBarColor(percent) {
            if(percent >= 100) return 'bg-emerald-500';
            if(percent >= 70) return 'bg-blue-500';
            if(percent >= 40) return 'bg-yellow-400';
            return 'bg-slate-300';
        }

        // ---------------------------------------------------------
        // RENDERIZADO (UI CARDS)
        // ---------------------------------------------------------
        function renderExplorer() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            const q = document.getElementById('filter-quarter').value;
            
            // Filtrar Objetivos por Área y Trimestre
            const objs = db.objectives.filter(o => {
                const objArea = o.area || 'Oficina Técnica';
                if (objArea !== CURRENT_AREA) return false;
                if (q === 'ALL') return true;
                const m = new Date(o.endDate).getMonth() + 1;
                if (q === 'Q1') return m<=3; if(q==='Q2') return m>3&&m<=6; if(q==='Q3') return m>6&&m<=9; return m>9;
            });

            if(!objs.length) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-400 opacity-50"><i data-lucide="inbox" size="48" class="mb-2"></i><span class="text-sm">No hay objetivos para ${q} en ${CURRENT_AREA}</span></div>`;
                lucide.createIcons();
                return;
            }

            objs.forEach(obj => {
                const progress = calculateProgress(obj, 'objective');
                const progressColor = getProgressBarColor(progress);
                const isExpanded = true; // Por defecto abierto

                // 1. Renderizar Hijos (KPIs Directos y Proyectos)
                let childrenHTML = '';

                // A. KPIs de Objetivo
                const kpis = db.kpis.filter(k => k.objectiveId === obj.id && !k.projectId);
                kpis.forEach(k => { childrenHTML += renderKpiCard(k); });

                // B. Proyectos
                const projs = db.projects.filter(p => p.objectiveId === obj.id);
                projs.forEach(p => { childrenHTML += renderProjectCard(p); });

                // HTML DEL OBJETIVO (CARD PRINCIPAL)
                container.innerHTML += `
                    <div class="card-objective group">
                        <div class="p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition" onclick="toggleAccordion('obj-${obj.id}', 'icon-o-${obj.id}')">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <i id="icon-o-${obj.id}" data-lucide="chevron-down" class="text-slate-300 rotate-icon"></i>
                                <div>
                                    <div class="flex items-center gap-2 mb-0.5">
                                        <span class="badge-type badge-obj">Objetivo</span>
                                        <span class="text-[10px] text-slate-400 font-mono">${obj.endDate}</span>
                                    </div>
                                    <h3 class="font-bold text-base text-slate-800 leading-tight truncate pr-4">${obj.title}</h3>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-6 flex-shrink-0">
                                <div class="opacity-0 group-hover:opacity-100 flex gap-1 transition-opacity">
                                    <button onclick="event.stopPropagation(); openEdit('objective', ${obj.id})" class="btn-icon"><i data-lucide="pencil" size="14"></i></button>
                                    <button onclick="event.stopPropagation(); cloneObjective(${obj.id})" class="btn-icon text-blue-400"><i data-lucide="copy" size="14"></i></button>
                                </div>
                                <div class="flex flex-col items-end w-24">
                                    <span class="text-xs font-bold text-slate-700">${progress}%</span>
                                    <div class="progress-track w-full h-1.5 bg-slate-100"><div class="progress-bar ${progressColor}" style="width: ${progress}%"></div></div>
                                </div>
                            </div>
                        </div>

                        <div id="obj-${obj.id}" class="accordion-content open">
                            <div class="accordion-inner pb-3 pr-3">
                                <div class="flex justify-end gap-2 mb-2 pr-1">
                                    <button onclick="openModal('project', ${obj.id})" class="text-[10px] font-bold text-slate-500 hover:text-purple-600 flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-200 transition"><i data-lucide="folder-plus" size="12"></i> + Proyecto</button>
                                    <button onclick="openModal('kpi', ${obj.id}, 'objective')" class="text-[10px] font-bold text-slate-500 hover:text-orange-600 flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-200 transition"><i data-lucide="bar-chart-2" size="12"></i> + KPI</button>
                                </div>
                                ${childrenHTML || '<div class="text-xs text-slate-300 italic text-center py-2 ml-4 border-l border-slate-100">Sin iniciativas aún.</div>'}
                            </div>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        function renderProjectCard(p) {
            const progress = calculateProgress(p, 'project');
            const progressColor = getProgressBarColor(progress);
            
            // Tareas
            const tasks = db.tasks.filter(t => t.projectId === p.id);
            let tasksHTML = '';
            tasks.forEach(t => {
                tasksHTML += `
                <div class="flex items-center gap-2 py-1 pl-2 hover:bg-slate-100/50 rounded group/task transition">
                    <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" class="w-3.5 h-3.5 text-blue-600 rounded border-slate-300 cursor-pointer focus:ring-0">
                    <span class="text-xs ${t.done?'line-through text-slate-400':'text-slate-600'} flex-1 truncate">${t.title}</span>
                    <button onclick="delTask(${t.id})" class="opacity-0 group-hover/task:opacity-100 text-slate-300 hover:text-rose-500 transition px-2"><i data-lucide="x" size="12"></i></button>
                </div>`;
            });
            tasksHTML += `<div class="pl-2 mt-1"><input type="text" placeholder="+ Añadir tarea rápida..." class="text-xs w-full bg-transparent border-b border-transparent focus:border-slate-300 outline-none text-slate-500 placeholder:text-slate-300 py-1" onkeydown="if(event.key==='Enter'){addTask(${p.id},this.value);this.value=''}"></div>`;

            // KPIs de Proyecto
            const pkpis = db.kpis.filter(k => k.projectId === p.id);
            let kpisHTML = '';
            pkpis.forEach(k => kpisHTML += renderKpiCard(k));

            return `
            <div class="card-project group/proj">
                <div class="p-2 pl-3 flex items-center justify-between cursor-pointer hover:bg-purple-50 transition" onclick="toggleAccordion('proj-${p.id}', 'icon-p-${p.id}')">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <i id="icon-p-${p.id}" data-lucide="chevron-right" size="16" class="text-slate-400 rotate-icon ${p.isCollapsed?'':'rotate-90'}"></i>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="badge-type badge-proj">Proyecto</span>
                                <span class="font-semibold text-sm text-slate-700 hover:text-purple-700" onclick="event.stopPropagation(); openEdit('project', ${p.id})">${p.title}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="opacity-0 group-hover/proj:opacity-100 transition-opacity">
                             <button onclick="event.stopPropagation(); openEdit('project', ${p.id})" class="btn-icon"><i data-lucide="pencil" size="12"></i></button>
                             <button onclick="event.stopPropagation(); openModal('kpi', ${p.id}, 'project')" class="btn-icon text-orange-400" title="Agregar KPI"><i data-lucide="bar-chart" size="12"></i></button>
                        </div>
                        <div class="flex items-center gap-2 w-24 justify-end">
                             <div class="progress-track w-16 h-1 bg-slate-200"><div class="progress-bar ${progressColor}" style="width: ${progress}%"></div></div>
                             <span class="text-[10px] font-bold text-slate-500">${progress}%</span>
                        </div>
                    </div>
                </div>
                <div id="proj-${p.id}" class="accordion-content ${p.isCollapsed?'':'open'} bg-white">
                    <div class="accordion-inner p-2 pl-8 border-t border-slate-100">
                        ${kpisHTML}
                        <div class="mt-2 space-y-0.5 border-l-2 border-slate-100 pl-2">
                            ${tasksHTML}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderKpiCard(k) {
            const progress = calculateProgress(k, 'kpi');
            const progressColor = getProgressBarColor(progress);
            return `
            <div class="card-kpi flex items-center justify-between p-2 mb-1 shadow-sm hover:shadow-md transition group/kpi">
                <div class="flex items-center gap-3 flex-1">
                    <div class="flex flex-col">
                        <span class="badge-type badge-kpi w-fit mb-0.5">KPI</span>
                        <span class="text-xs font-semibold text-slate-700 cursor-pointer hover:text-orange-600" onclick="openEdit('kpi', ${k.id})">${k.title}</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                     <button onclick="openEdit('kpi', ${k.id})" class="btn-icon opacity-0 group-hover/kpi:opacity-100"><i data-lucide="pencil" size="12"></i></button>
                     
                     <div class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-100">
                        <input type="number" value="${k.currentValue}" onchange="updateKpiVal(${k.id}, this.value)" class="inline-input text-xs font-bold text-slate-700" placeholder="0">
                        <span class="text-[10px] text-slate-400">/ ${k.targetValue}</span>
                     </div>
                     
                     <div class="w-12 h-1 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full ${progressColor}" style="width: ${progress}%"></div>
                     </div>
                </div>
            </div>`;
        }

        // ---------------------------------------------------------
        // FUNCIONES AUXILIARES & ACCIONES
        // ---------------------------------------------------------
        function toggleAccordion(id, iconId) { 
            const el = document.getElementById(id);
            const icon = document.getElementById(iconId);
            el.classList.toggle('open'); 
            icon.classList.toggle('rotate-90'); 
            
            // Guardar estado colapsado si es proyecto
            if(id.startsWith('proj-')) {
                const pid = parseInt(id.split('-')[1]);
                const p = db.projects.find(x => x.id === pid);
                if(p) p.isCollapsed = !el.classList.contains('open');
            }
        }

        function updateKpiVal(id, v) { const k=db.kpis.find(x=>x.id===id); if(k){ k.currentValue=v; saveToGoogle(); renderExplorer(); } } 
        function toggleTask(id) { const t=db.tasks.find(x=>x.id===id); if(t){ t.done=!t.done; saveToGoogle(); renderExplorer(); } }
        function addTask(pid, t) { if(t.trim()){ db.tasks.push({id:Date.now(), projectId:pid, title:t, done:false}); saveToGoogle(); renderExplorer(); } }
        function delTask(id) { if(confirm('¿Borrar tarea?')){ db.tasks=db.tasks.filter(t=>t.id!==id); saveToGoogle(); renderExplorer(); } }
        
        function switchArea(newArea) { CURRENT_AREA = newArea; localStorage.setItem('okr_current_area', newArea); renderExplorer(); }
        function switchView(v) { 
            document.getElementById('view-explorer').classList.toggle('hidden', v!=='explorer'); 
            document.getElementById('view-dashboard').classList.toggle('hidden', v!=='dashboard'); 
            document.getElementById('header-actions').classList.toggle('hidden', v==='dashboard');
            document.getElementById('view-title').innerText = v==='explorer' ? 'Mis OKRs' : 'Reporte General';
            if(v==='dashboard') renderDashboard(); 
        }
        function toggleLoader(s) { document.getElementById('global-loader').classList.toggle('hidden', !s); }
        function toggleAll(expand) {
             document.querySelectorAll('.accordion-content').forEach(el => expand ? el.classList.add('open') : el.classList.remove('open'));
             document.querySelectorAll('.rotate-icon').forEach(el => expand ? el.classList.remove('rotate-90') : el.classList.add('rotate-90')); // Lógica inversa por diseño de icono
        }

        // Clone
        function cloneObjective(oid) {
            const o = db.objectives.find(x => x.id === oid); if(!o || !confirm('¿Duplicar Objetivo?')) return;
            const newOid = Date.now();
            db.objectives.push({...o, id: newOid, title: "Copia - " + o.title, startDate: new Date().toISOString().split('T')[0], endDate: ""});
            // Clonar hijos (simplificado)
            db.kpis.filter(k => k.objectiveId === oid && !k.projectId).forEach(k => db.kpis.push({...k, id: Date.now()+Math.random(), objectiveId: newOid, currentValue: k.startValue}));
            db.projects.filter(p => p.objectiveId === oid).forEach(p => {
                const newPid = Date.now() + Math.random();
                db.projects.push({...p, id: newPid, objectiveId: newOid});
                db.tasks.filter(t => t.projectId === p.id).forEach(t => db.tasks.push({...t, id: Date.now()+Math.random(), projectId: newPid, done: false}));
            });
            saveToGoogle(); renderExplorer();
        }

        // ---------------------------------------------------------
        // MODALES Y EDICIÓN
        // ---------------------------------------------------------
        function openModal(type, pid, ctx) { 
            document.getElementById('modal-backdrop').classList.remove('hidden'); 
            document.getElementById('edit-id').value=''; 
            document.getElementById('entity-type').value=type; 
            document.getElementById('parent-id').value=pid||''; 
            document.getElementById('context-type').value=ctx||'';
            
            document.getElementById('modal-title').innerText = type === 'objective' ? 'Nuevo Objetivo Estratégico' : type === 'project' ? 'Nuevo Proyecto' : 'Configurar KPI';
            document.getElementById('field-metrics').classList.toggle('hidden', type!=='kpi'); 
            document.getElementById('btn-delete').classList.add('hidden');
            
            // Reset fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inp-start').value = today;
            ['inp-title','inp-owner','inp-tags','inp-val-start','inp-val-target','inp-weight','inp-end'].forEach(i => document.getElementById(i).value='');
            renderOwnerSuggestions();
        }

        function openEdit(type, id) { 
            const list = type==='objective'?db.objectives:type==='project'?db.projects:db.kpis;
            const i = list.find(x=>x.id===id); if(!i)return; 
            
            openModal(type, null, null); 
            document.getElementById('edit-id').value=id; 
            document.getElementById('modal-title').innerText='Editar '+type; 
            document.getElementById('btn-delete').classList.remove('hidden'); 
            
            // Fill
            document.getElementById('inp-title').value=i.title; 
            document.getElementById('inp-owner').value=i.owner||''; 
            document.getElementById('inp-weight').value=i.weight||''; 
            document.getElementById('inp-start').value=i.startDate; 
            document.getElementById('inp-end').value=i.endDate; 
            if(type==='kpi'){ 
                document.getElementById('inp-val-start').value=i.startValue; 
                document.getElementById('inp-val-target').value=i.targetValue; 
            }
        }
        
        function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }
        
        function deleteItemFromModal() {
            const id=parseInt(document.getElementById('edit-id').value);
            const type=document.getElementById('entity-type').value;
            if(!id||!confirm('¿Eliminar definitivamente?'))return;
            
            if(type==='objective'){ db.objectives=db.objectives.filter(x=>x.id!==id); db.projects=db.projects.filter(x=>x.objectiveId!==id); db.kpis=db.kpis.filter(x=>x.objectiveId!==id); }
            else if(type==='project'){ db.projects=db.projects.filter(x=>x.id!==id); db.tasks=db.tasks.filter(x=>x.projectId!==id); db.kpis=db.kpis.filter(x=>x.projectId!==id); }
            else if(type==='kpi'){ db.kpis=db.kpis.filter(x=>x.id!==id); }
            
            saveToGoogle(); closeModal(); renderExplorer();
        }

        function saveDataFromModal() {
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('entity-type').value;
            const pid = parseInt(document.getElementById('parent-id').value);
            const w = parseFloat(document.getElementById('inp-weight').value)||1;
            
            const common = { 
                title: document.getElementById('inp-title').value, 
                owner: document.getElementById('inp-owner').value, 
                weight: w, 
                startDate: document.getElementById('inp-start').value, 
                endDate: document.getElementById('inp-end').value,
                tags: document.getElementById('inp-tags').value.split(',').filter(Boolean)
            };
            
            // Save Owner history
            if(common.owner && !recentOwners.includes(common.owner)){ 
                recentOwners.unshift(common.owner); recentOwners=recentOwners.slice(0,5); 
                localStorage.setItem('okr_recent_owners',JSON.stringify(recentOwners)); 
            }

            if(id) { // UPDATE
                const numId = parseInt(id);
                const list = type==='objective'?db.objectives:type==='project'?db.projects:db.kpis;
                const idx = list.findIndex(x=>x.id===numId);
                if(idx !== -1) {
                    list[idx] = {...list[idx], ...common};
                    if(type==='kpi'){ list[idx].startValue=document.getElementById('inp-val-start').value; list[idx].targetValue=document.getElementById('inp-val-target').value; }
                }
            } else { // CREATE
                const newItem = { id: Date.now(), ...common };
                if(type === 'objective') { newItem.area = CURRENT_AREA; db.objectives.push(newItem); }
                else if(type === 'project') { newItem.objectiveId = pid; newItem.isCollapsed = false; db.projects.push(newItem); }
                else { // KPI
                    newItem.startValue = document.getElementById('inp-val-start').value; 
                    newItem.targetValue = document.getElementById('inp-val-target').value; 
                    newItem.currentValue = newItem.startValue; 
                    if(document.getElementById('context-type').value==='objective') newItem.objectiveId = pid; else newItem.projectId = pid; 
                    db.kpis.push(newItem); 
                }
            }
            saveToGoogle(); closeModal(); renderExplorer();
        }

        function renderOwnerSuggestions() { 
            const s=document.getElementById('owner-suggestions'); s.innerHTML=''; 
            recentOwners.forEach(o=>{ 
                const c=document.createElement('div'); c.className='owner-chip bg-slate-100 text-[10px] px-2 py-0.5 rounded cursor-pointer hover:bg-slate-200'; c.innerText=o; c.onclick=()=>document.getElementById('inp-owner').value=o; s.appendChild(c); 
            }); 
        }

        function renderDashboard() {
            const tbody = document.getElementById('report-body'); tbody.innerHTML = '';
            const objs = db.objectives.filter(o => (o.area || 'Oficina Técnica') === CURRENT_AREA);
            
            objs.forEach(obj => {
                const p = calculateProgress(obj, 'objective');
                const c = getProgressBarColor(p);
                tbody.innerHTML += `
                <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                    <td class="p-3 pl-4 font-semibold text-slate-700">${obj.title}</td>
                    <td class="p-3 text-slate-500">${obj.owner||'-'}</td>
                    <td class="p-3 font-mono text-slate-400">${obj.endDate}</td>
                    <td class="p-3"><div class="flex items-center gap-2"><div class="progress-track flex-1 h-1.5"><div class="progress-bar ${c}" style="width: ${p}%"></div></div><span class="text-[10px] font-bold">${p}%</span></div></td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded-full text-[9px] font-bold ${p===100?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-600'}">${p===100?'COMPLETO':p>0?'EN CURSO':'INICIO'}</span></td>
                </tr>`;
            });
        }
        
        function exportCSV() {
            let csv = "Tipo,Titulo,Responsable,Progreso\n";
            db.objectives.filter(o => (o.area || 'Oficina Técnica') === CURRENT_AREA).forEach(o => {
                csv += `Objetivo,"${o.title}","${o.owner||''}",${calculateProgress(o,'objective')}%\n`;
            });
            const b = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'okr_export.csv'; a.click();
        }
    </script>
</body>
</html>
