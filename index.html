<!DOCTYPE html>
<html lang="es" class="bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Manager | SaaS Edition v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-soft: #e0e7ff;
            --bg-subtle: #f8fafc;
        }

        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; }
        
        /* UI Components */
        .glass-panel { 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .glass-panel:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        .pacing-line { 
            position: absolute; top: 0; bottom: 0; 
            border-right: 1.5px dashed #94a3b8; 
            z-index: 10; opacity: 0.4; 
        }
        
        /* Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; border: 1px solid transparent; }
        .badge-on-track { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }
        .badge-at-risk { background: #fffbeb; color: #b45309; border-color: #fde68a; }
        .badge-off-track { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        
        .kpi-tag { font-size: 9px; font-weight: 800; color: var(--primary); background: var(--primary-soft); padding: 1px 4px; border-radius: 3px; }

        /* Chips de Responsables */
        .owner-chip {
            font-size: 11px; padding: 2px 8px; border-radius: 999px;
            background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;
            cursor: pointer; transition: all 0.1s;
        }
        .owner-chip:hover { background: #e2e8f0; color: #1e293b; border-color: #cbd5e1; }

        /* Quarter Selector Buttons */
        .q-btn {
            font-size: 10px; font-weight: 600; padding: 4px 8px; 
            border: 1px solid #e2e8f0; background: white; color: #64748b;
            border-radius: 4px; cursor: pointer; transition: all 0.2s;
        }
        .q-btn:hover { border-color: var(--primary); color: var(--primary); background: #f5f3ff; }

        /* Accordion Utils */
        .accordion-content { transition: grid-template-rows 0.2s ease-out; display: grid; grid-template-rows: 0fr; }
        .accordion-content.open { grid-template-rows: 1fr; }
        .accordion-inner { overflow: hidden; }
        .rotate-icon { transition: transform 0.2s; }
        
        /* Loader */
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-600 h-screen flex overflow-hidden selection:bg-indigo-100">

    <aside class="w-16 lg:w-60 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 z-30 transition-all duration-300">
        <div class="h-14 flex items-center justify-center lg:justify-start lg:px-5 border-b border-slate-100">
            <div class="bg-indigo-600 p-1.5 rounded-lg shadow-sm shadow-indigo-200"><i data-lucide="target" class="text-white" size="18"></i></div>
            <span class="hidden lg:block ml-3 font-bold text-slate-800 tracking-tight">OKR <span class="text-indigo-600">SaaS</span></span>
        </div>
        
        <nav class="flex-1 p-2 space-y-1 mt-2">
            <button onclick="switchView('explorer')" class="w-full flex items-center justify-center lg:justify-start gap-3 px-3 py-2 rounded-md bg-indigo-50 text-indigo-700 font-medium transition" id="btn-explorer">
                <i data-lucide="layers" size="18"></i> <span class="hidden lg:block">Mis OKRs</span>
            </button>
            <button onclick="switchView('dashboard')" class="w-full flex items-center justify-center lg:justify-start gap-3 px-3 py-2 rounded-md hover:bg-slate-50 text-slate-500 hover:text-slate-900 transition" id="btn-dashboard">
                <i data-lucide="pie-chart" size="18"></i> <span class="hidden lg:block">Reportes</span>
            </button>
        </nav>

        <div class="p-3 border-t border-slate-100">
             <div id="sync-status" class="hidden lg:flex items-center gap-2 text-[10px] text-slate-400 mb-2 justify-center">
                 <span class="w-2 h-2 rounded-full bg-emerald-400"></span> Conectado a Google
             </div>
             <button onclick="configureApi()" class="w-full py-2 text-xs text-slate-500 hover:bg-slate-50 border border-slate-200 rounded-md transition flex justify-center gap-2 items-center">
                <i data-lucide="settings" size="14"></i> <span class="hidden lg:block">Configurar Cloud</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#f8fafc] p-4 lg:p-8 relative">
        
        <div id="global-loader" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm hidden">
            <div class="flex flex-col items-center gap-3">
                <div class="spinner w-8 h-8 border-4 border-indigo-600 border-t-transparent"></div>
                <span class="text-xs font-medium text-slate-500 animate-pulse">Sincronizando...</span>
            </div>
        </div>

        <div id="view-explorer" class="max-w-5xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Objetivos Activos</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <p class="text-xs text-slate-400">Gestión de rendimiento</p>
                        <select id="filter-quarter" onchange="renderExplorer()" class="text-xs border border-slate-200 rounded px-2 py-0.5 bg-white text-slate-600 focus:outline-none focus:border-indigo-500 cursor-pointer">
                            <option value="ALL">Todo el Año</option>
                            <option value="Q1">Q1 (Ene-Mar)</option>
                            <option value="Q2">Q2 (Abr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dic)</option>
                        </select>
                    </div>
                </div>
                <button onclick="openModal('objective')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md shadow-sm shadow-indigo-200 flex items-center gap-2 text-xs font-semibold transition active:scale-95">
                    <i data-lucide="plus" size="16"></i> Nuevo Objetivo
                </button>
            </header>

            <div id="tree-container" class="space-y-4 pb-20">
                </div>
        </div>

        <div id="view-dashboard" class="hidden max-w-6xl mx-auto space-y-6">
            <header>
                <h1 class="text-xl font-bold text-slate-800">Rendimiento</h1>
            </header>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-panel p-4 border-l-4 border-indigo-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Avance Total</span>
                    <div class="text-3xl font-bold text-slate-800 mt-1" id="dash-total">0%</div>
                </div>
                <div class="glass-panel p-4 border-l-4 border-emerald-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">A Tiempo</span>
                    <div class="text-3xl font-bold text-emerald-600 mt-1" id="dash-ontrack">0</div>
                </div>
                <div class="glass-panel p-4 border-l-4 border-amber-400">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Riesgo</span>
                    <div class="text-3xl font-bold text-amber-500 mt-1" id="dash-atrisk">0</div>
                </div>
                <div class="glass-panel p-4 border-l-4 border-rose-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Retrasado</span>
                    <div class="text-3xl font-bold text-rose-600 mt-1" id="dash-offtrack">0</div>
                </div>
            </div>

            <div class="glass-panel p-5">
                <h3 class="font-semibold text-slate-700 mb-4 text-sm">Salud de Objetivos</h3>
                <div class="h-64 w-full flex justify-center">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md shadow-2xl transform transition-all scale-100 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 id="modal-title" class="text-sm font-bold text-slate-800">Elemento</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition"><i data-lucide="x" size="18"></i></button>
            </div>
            
            <div class="p-5 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="parent-id">
                <input type="hidden" id="entity-type">
                <input type="hidden" id="context-type">

                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Título</label>
                    <input id="inp-title" type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="Nombre descriptivo...">
                </div>

                <div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Responsable</label>
                            <input id="inp-owner" type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Nombre o Iniciales">
                        </div>
                        <div id="field-weight">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 flex justify-between">
                                Contribución <span class="text-slate-300 font-normal">1-10</span>
                            </label>
                            <input id="inp-weight" type="number" min="1" max="10" value="1" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <div id="owner-suggestions" class="flex flex-wrap gap-2 mt-2">
                        </div>
                </div>

                <div class="bg-slate-50 p-3 rounded-md border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                         <label class="block text-[10px] font-bold text-slate-400 uppercase">Periodo / Quarter</label>
                         <div class="flex gap-1">
                             <button type="button" onclick="setQuarterDate(1)" class="q-btn">Q1</button>
                             <button type="button" onclick="setQuarterDate(2)" class="q-btn">Q2</button>
                             <button type="button" onclick="setQuarterDate(3)" class="q-btn">Q3</button>
                             <button type="button" onclick="setQuarterDate(4)" class="q-btn">Q4</button>
                         </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1">Inicio</label>
                            <input id="inp-start" type="date" class="w-full p-1.5 text-xs border border-slate-200 rounded bg-white">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1">Finalización</label>
                            <input id="inp-end" type="date" class="w-full p-1.5 text-xs border border-slate-200 rounded bg-white font-medium text-slate-700">
                        </div>
                    </div>
                </div>
                
                <div id="field-metrics" class="hidden bg-indigo-50/50 p-3 rounded-md border border-indigo-100 grid grid-cols-2 gap-3">
                     <div class="col-span-2 text-[10px] font-bold text-indigo-800 uppercase tracking-wide">Métricas KPI</div>
                     <div>
                        <label class="block text-[10px] text-slate-500 mb-1">Inicial</label>
                        <input id="inp-val-start" type="number" class="w-full p-1.5 text-xs border border-indigo-200 rounded text-center bg-white font-mono">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-500 mb-1">Meta</label>
                        <input id="inp-val-target" type="number" class="w-full p-1.5 text-xs border border-indigo-200 rounded font-bold text-indigo-700 text-center bg-white font-mono">
                    </div>
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Etiquetas</label>
                    <input id="inp-tags" type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Estrategia, Ventas...">
                </div>
            </div>

            <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex justify-end gap-2 mt-auto">
                <button onclick="closeModal()" class="px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-200 rounded-md transition">Cancelar</button>
                <button onclick="saveDataFromModal()" class="px-4 py-2 text-xs font-bold bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 transition">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN API
        let API_URL = localStorage.getItem('okr_api_url') || 'https://script.google.com/macros/s/AKfycbwvqc8WF33hbifl43JwMFGp1PH-ubndf7PT4cZhn3XPBR5jUoHoEEPoVBOPVje_MbE7hw/exec';
        
        let db = { objectives: [], projects: [], kpis: [], tasks: [] };
        
        // Persistencia local de dueños recientes
        let recentOwners = JSON.parse(localStorage.getItem('okr_recent_owners')) || [];

        // --- API SYNC ---
        async function loadFromGoogle() {
            if(!API_URL) return alert("Error: URL de API no configurada.");
            toggleLoader(true);
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                db = data;
                renderExplorer();
            } catch(e) {
                console.error(e);
                alert("Error de conexión. Verifica tu internet.");
            } finally {
                toggleLoader(false);
            }
        }

        async function saveToGoogle() {
            if(!API_URL) return;
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 8000); 
            
            try {
                const btn = document.getElementById('sync-status');
                if(btn) btn.innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span> Guardando...';

                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(db)
                });
                if(btn) btn.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-400"></span> Sincronizado';
            } catch(e) {
                const btn = document.getElementById('sync-status');
                if(btn) btn.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> Error Sync';
            }
        }

        function toggleLoader(show) {
            const el = document.getElementById('global-loader');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        function configureApi() {
            const url = prompt("URL Google Apps Script:", API_URL);
            if(url) {
                localStorage.setItem('okr_api_url', url);
                API_URL = url;
                loadFromGoogle();
            }
        }

        // --- CORE CALCULATIONS ---
        function calculateMetrics(item, type) {
            const now = new Date();
            const start = new Date(item.startDate);
            const end = new Date(item.endDate);
            const totalDays = Math.max(1, (end - start) / (1000 * 60 * 60 * 24));
            const elapsedDays = Math.max(0, (now - start) / (1000 * 60 * 60 * 24));
            let pacing = Math.min(100, Math.max(0, (elapsedDays / totalDays) * 100));

            if (type === 'kpi') {
                let actual = 0;
                if (item.targetValue > item.startValue) {
                    actual = ((item.currentValue - item.startValue) / (item.targetValue - item.startValue)) * 100;
                }
                return getStatusObject(Math.min(100, Math.max(0, actual)), pacing);
            }

            let childrenMetrics = [];
            const childKpis = db.kpis.filter(k => 
                (type === 'objective' && k.objectiveId === item.id && !k.projectId) || 
                (type === 'project' && k.projectId === item.id)
            );
            childKpis.forEach(k => {
                const m = calculateMetrics(k, 'kpi');
                childrenMetrics.push({ progress: m.actual, weight: k.weight || 1, pacing: m.pacing });
            });

            if (type === 'objective') {
                const childProjs = db.projects.filter(p => p.objectiveId === item.id);
                childProjs.forEach(p => {
                    const m = calculateMetrics(p, 'project');
                    childrenMetrics.push({ progress: m.actual, weight: p.weight || 1, pacing: m.pacing });
                });
            }

            if (type === 'project') {
                const childTasks = db.tasks.filter(t => t.projectId === item.id);
                childTasks.forEach(t => {
                    childrenMetrics.push({ progress: t.done ? 100 : 0, weight: 1, pacing: pacing });
                });
            }

            if (childrenMetrics.length === 0) return { actual: 0, pacing: 0, css: 'bg-slate-100 text-slate-400 border-slate-200', label: 'Nuevo' };

            const totalWeight = childrenMetrics.reduce((sum, c) => sum + parseFloat(c.weight), 0);
            const weightedSum = childrenMetrics.reduce((sum, c) => sum + (c.progress * parseFloat(c.weight)), 0);
            const avgActual = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
            const maxPacing = Math.max(...childrenMetrics.map(c => c.pacing));

            return getStatusObject(avgActual, maxPacing);
        }

        function getStatusObject(actual, pacing) {
            let label = 'Retrasado'; let css = 'badge-off-track';
            if (pacing < 10) { label = 'Inicio'; css = 'badge-on-track'; }
            else {
                const ratio = actual / pacing;
                if (ratio >= 0.9) { label = 'A Tiempo'; css = 'badge-on-track'; }
                else if (ratio >= 0.7) { label = 'Riesgo'; css = 'badge-at-risk'; }
            }
            return { actual: Math.round(actual), pacing: Math.round(pacing), css, label };
        }

        // --- RENDERIZADO EXPLORER ---
        function renderExplorer() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            
            // FILTRADO POR QUARTER
            const qFilter = document.getElementById('filter-quarter').value;
            let filteredObjs = db.objectives;

            if (qFilter !== 'ALL') {
                filteredObjs = db.objectives.filter(obj => {
                    // Lógica simple: si la fecha fin del objetivo cae en el Q seleccionado
                    const d = new Date(obj.endDate);
                    const month = d.getMonth() + 1; // 1-12
                    if (qFilter === 'Q1') return month >= 1 && month <= 3;
                    if (qFilter === 'Q2') return month >= 4 && month <= 6;
                    if (qFilter === 'Q3') return month >= 7 && month <= 9;
                    if (qFilter === 'Q4') return month >= 10 && month <= 12;
                    return true;
                });
            }
            
            if(!filteredObjs.length) {
                container.innerHTML = `<div class="text-center py-12 border-2 border-dashed border-slate-200 rounded-lg text-slate-400 text-sm bg-white">
                    No se encontraron objetivos para ${qFilter === 'ALL' ? 'este periodo' : qFilter}.
                    <br><span class="text-xs">Crea uno nuevo o cambia el filtro.</span>
                </div>`;
                return;
            }

            filteredObjs.forEach(obj => {
                const m = calculateMetrics(obj, 'objective');
                const projects = db.projects.filter(p => p.objectiveId === obj.id);
                const directKpis = db.kpis.filter(k => k.objectiveId === obj.id && !k.projectId);
                
                // Render Hijos Directos
                let childrenHtml = '';
                directKpis.forEach(k => { childrenHtml += renderRow('kpi', k, calculateMetrics(k, 'kpi')); });
                
                // Render Proyectos
                projects.forEach(p => {
                    const pm = calculateMetrics(p, 'project');
                    const pKpis = db.kpis.filter(k => k.projectId === p.id);
                    const pTasks = db.tasks.filter(t => t.projectId === p.id);
                    
                    // Tareas
                    let taskSection = '';
                    if(pTasks.length > 0 || true) {
                        let tasksHtml = pTasks.map(t => `
                            <div class="flex items-center gap-2 group/task py-0.5">
                                <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})" class="accent-indigo-600 w-3 h-3 cursor-pointer rounded border-slate-300">
                                <span class="text-xs ${t.done ? 'line-through text-slate-300' : 'text-slate-600'}">${t.title}</span>
                                <button onclick="deleteTask(${t.id})" class="ml-auto opacity-0 group-hover/task:opacity-100 text-slate-300 hover:text-rose-500 transition"><i data-lucide="x" size="10"></i></button>
                            </div>
                        `).join('');
                        
                        taskSection = `
                        <div class="mt-2">
                             <button onclick="toggleAccordion('tasks-${p.id}')" class="flex items-center gap-1 text-[10px] font-bold text-slate-400 hover:text-indigo-600 uppercase tracking-wide mb-1 transition">
                                <i data-lucide="chevron-right" size="12" class="rotate-icon" id="icon-tasks-${p.id}"></i> ${pTasks.length} Tareas
                             </button>
                             <div id="tasks-${p.id}" class="accordion-content">
                                <div class="accordion-inner pl-4 border-l border-slate-100 space-y-1 pb-2">
                                    ${tasksHtml}
                                    <input type="text" placeholder="+ Tarea rápida..." class="text-xs w-full bg-transparent border-b border-transparent hover:border-slate-200 focus:border-indigo-400 outline-none py-1 transition" onkeydown="if(event.key==='Enter'){addTask(${p.id}, this.value); this.value='';}">
                                </div>
                             </div>
                        </div>`;
                    }

                    // Project KPIs
                    let kpiHtml = '';
                    pKpis.forEach(pk => { kpiHtml += renderRow('kpi', pk, calculateMetrics(pk, 'kpi')); });

                    childrenHtml += `
                        <div class="ml-2 pl-3 border-l-2 border-slate-100 mt-2">
                            ${renderRow('project', p, pm)}
                            <div class="pl-1 mt-1">
                                ${taskSection}
                                ${kpiHtml}
                            </div>
                        </div>
                    `;
                });

                // Tarjeta Objetivo Principal
                container.innerHTML += `
                <div class="glass-panel mb-4">
                    <div class="p-3 flex items-start gap-3">
                        <button onclick="toggleAccordion('content-${obj.id}')" class="mt-0.5 text-slate-400 hover:text-indigo-600 transition"><i id="icon-content-${obj.id}" data-lucide="chevron-down" size="18"></i></button>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="mountain" class="text-indigo-600" size="16"></i>
                                        <h3 class="font-bold text-sm text-slate-800 cursor-pointer hover:text-indigo-600 transition" onclick="openEdit('objective', ${obj.id})">${obj.title}</h3>
                                        ${renderTags(obj.tags)}
                                    </div>
                                    <div class="flex gap-3 text-[10px] text-slate-400 mt-0.5">
                                        <span class="flex items-center gap-1"><i data-lucide="user" size="10"></i> ${obj.owner || '-'}</span>
                                        <span class="flex items-center gap-1"><i data-lucide="calendar" size="10"></i> ${obj.endDate}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <span class="badge ${m.css}">${m.label}</span>
                                    
                                    <div class="flex gap-1 mt-1"> 
                                        <button onclick="openModal('project', ${obj.id})" class="px-2 py-0.5 rounded border border-slate-200 text-[10px] text-slate-500 hover:border-indigo-300 hover:text-indigo-600 bg-white shadow-sm transition flex items-center gap-1">
                                            <i data-lucide="folder-plus" size="10"></i> Proy
                                        </button>
                                        <button onclick="openModal('kpi', ${obj.id}, 'objective')" class="px-2 py-0.5 rounded border border-slate-200 text-[10px] text-slate-500 hover:border-indigo-300 hover:text-indigo-600 bg-white shadow-sm transition flex items-center gap-1">
                                            <i data-lucide="bar-chart-2" size="10"></i> KPI
                                        </button>
                                    </div>

                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 h-1.5 bg-slate-100 rounded-full relative overflow-hidden">
                                    <div class="pacing-line" style="left: ${m.pacing}%"></div>
                                    <div class="h-full rounded-full transition-all duration-700 ${m.css.replace('badge-','bg-').replace('border-','')}" style="width: ${m.actual}%; opacity: 0.8"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-700 w-8 text-right">${m.actual}%</span>
                            </div>
                        </div>
                    </div>
                    <div id="content-${obj.id}" class="accordion-content open">
                        <div class="accordion-inner bg-slate-50/30 border-t border-slate-50 p-2 pt-0">
                            ${childrenHtml || '<div class="text-[10px] text-slate-300 p-2 italic">Sin elementos.</div>'}
                        </div>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        }

        function renderRow(type, item, m) {
            const isKpi = type === 'kpi';
            const icon = isKpi ? '<span class="kpi-tag">KPI</span>' : '<i data-lucide="folder" class="text-slate-400 fill-slate-50" size="14"></i>';
            const bg = isKpi ? 'bg-white border-transparent' : 'bg-white border-slate-200 shadow-sm';
            
            const valInput = isKpi ? `
                <div class="flex items-center gap-1 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 group-hover:border-indigo-100 transition">
                    <input type="number" value="${item.currentValue}" onchange="updateKpiVal(${item.id}, this.value)" 
                    class="w-12 text-right bg-transparent text-[10px] font-mono font-bold focus:outline-none text-slate-600">
                    <span class="text-[9px] text-slate-300">/ ${item.targetValue}</span>
                </div>
            ` : '';

            // Botón Agregar KPI al Proyecto (Restaurado y visible al hover)
            const addBtn = !isKpi ? `
                <button onclick="openModal('kpi', ${item.id}, 'project')" class="text-[9px] border border-slate-200 bg-slate-50 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 px-1.5 py-0.5 rounded transition font-medium flex items-center gap-1">
                    <i data-lucide="plus" size="8"></i> KPI
                </button>
            ` : '';

            const contrib = !isKpi || item.weight > 1 ? `<span class="text-[9px] text-slate-300" title="Contribución">w:${item.weight||1}</span>` : '';

            return `
            <div class="flex items-center gap-2 p-2 mb-1 rounded border ${bg} group hover:border-indigo-200 transition">
                <div class="w-6 flex justify-center flex-shrink-0">${icon}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center h-5">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-xs font-medium text-slate-700 truncate cursor-pointer hover:text-indigo-600 transition" onclick="openEdit('${type}', ${item.id})">${item.title}</span>
                            ${contrib}
                            ${renderTags(item.tags)}
                            ${addBtn}
                        </div>
                        <div class="flex items-center gap-2">
                            ${valInput}
                            <div class="w-1.5 h-1.5 rounded-full ${m.css.replace('badge-','bg-').replace('border-','')}"></div>
                        </div>
                    </div>
                    <div class="h-1 bg-slate-100 rounded-full w-full relative overflow-hidden mt-1 opacity-60 group-hover:opacity-100 transition">
                        <div class="pacing-line" style="left: ${m.pacing}%"></div>
                        <div class="h-full rounded-full ${m.css.replace('badge-','bg-').replace('border-','')}" style="width: ${m.actual}%"></div>
                    </div>
                </div>
            </div>`;
        }

        // --- INTERACCIONES ---
        function toggleAccordion(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            el.classList.toggle('open');
            if(icon) icon.style.transform = el.classList.contains('open') ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function updateKpiVal(id, val) {
            const k = db.kpis.find(x => x.id === id);
            if(k) { k.currentValue = parseFloat(val); saveToGoogle(); renderExplorer(); }
        }

        function toggleTask(id) {
            const t = db.tasks.find(x => x.id === id);
            if(t) { t.done = !t.done; saveToGoogle(); renderExplorer(); }
        }
        
        function addTask(projId, title) {
            if(!title) return;
            db.tasks.push({ id: Date.now(), projectId: projId, title, done: false });
            saveToGoogle(); renderExplorer();
        }

        function deleteTask(id) {
            if(confirm('¿Eliminar?')) {
                db.tasks = db.tasks.filter(t => t.id !== id);
                saveToGoogle(); renderExplorer();
            }
        }

        // --- GESTIÓN DE MODALES ---
        function openModal(type, parentId, context) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('edit-id').value = '';
            document.getElementById('entity-type').value = type;
            document.getElementById('parent-id').value = parentId || '';
            document.getElementById('context-type').value = context || '';

            const titles = { 'objective': 'Nuevo Objetivo', 'project': 'Nuevo Proyecto', 'kpi': 'Nuevo KPI' };
            document.getElementById('modal-title').innerText = titles[type];
            
            document.getElementById('field-weight').classList.toggle('hidden', type === 'objective');
            document.getElementById('field-metrics').classList.toggle('hidden', type !== 'kpi');
            
            // Reset Fechas (Año actual)
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('inp-start').value = d;
            document.getElementById('inp-end').value = d;
            
            // Reset Inputs
            ['inp-title','inp-owner','inp-tags','inp-val-start','inp-val-target'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('inp-weight').value = 1;

            updateOwnerSuggestions();
        }

        function openEdit(type, id) {
            const item = (type === 'objective' ? db.objectives : type === 'project' ? db.projects : db.kpis).find(x=>x.id===id);
            if(!item) return;
            
            openModal(type, null, null);
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-title').innerText = "Editar " + type;
            
            document.getElementById('inp-title').value = item.title;
            document.getElementById('inp-owner').value = item.owner || '';
            document.getElementById('inp-weight').value = item.weight || 1;
            document.getElementById('inp-start').value = item.startDate;
            document.getElementById('inp-end').value = item.endDate;
            document.getElementById('inp-tags').value = item.tags ? item.tags.join(', ') : '';
            
            if(type === 'kpi') {
                document.getElementById('inp-val-start').value = item.startValue;
                document.getElementById('inp-val-target').value = item.targetValue;
            }
            updateOwnerSuggestions();
        }

        function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }

        function saveDataFromModal() {
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('entity-type').value;
            const ownerName = document.getElementById('inp-owner').value.trim();
            
            // Guardar dueño reciente
            if(ownerName && !recentOwners.includes(ownerName)) {
                recentOwners.unshift(ownerName);
                if(recentOwners.length > 8) recentOwners.pop();
                localStorage.setItem('okr_recent_owners', JSON.stringify(recentOwners));
            }

            const common = {
                title: document.getElementById('inp-title').value,
                owner: ownerName,
                weight: parseFloat(document.getElementById('inp-weight').value) || 1,
                startDate: document.getElementById('inp-start').value,
                endDate: document.getElementById('inp-end').value,
                tags: document.getElementById('inp-tags').value.split(',').map(s=>s.trim()).filter(Boolean)
            };

            if(id) { 
                const numId = parseInt(id);
                let col = type === 'objective' ? db.objectives : type === 'project' ? db.projects : db.kpis;
                let idx = col.findIndex(x => x.id === numId);
                if(idx !== -1) {
                    col[idx] = { ...col[idx], ...common };
                    if(type==='kpi') {
                        col[idx].startValue = parseFloat(document.getElementById('inp-val-start').value);
                        col[idx].targetValue = parseFloat(document.getElementById('inp-val-target').value);
                    }
                }
            } else { 
                const pid = parseInt(document.getElementById('parent-id').value);
                const ctx = document.getElementById('context-type').value;
                const newItem = { id: Date.now(), ...common };
                
                if(type === 'objective') db.objectives.push(newItem);
                else if(type === 'project') { newItem.objectiveId = pid; db.projects.push(newItem); }
                else if(type === 'kpi') {
                    newItem.startValue = parseFloat(document.getElementById('inp-val-start').value);
                    newItem.targetValue = parseFloat(document.getElementById('inp-val-target').value);
                    newItem.currentValue = newItem.startValue;
                    if(ctx === 'objective') newItem.objectiveId = pid; else newItem.projectId = pid;
                    db.kpis.push(newItem);
                }
            }
            saveToGoogle(); closeModal(); renderExplorer();
        }

        // --- FEATURES NUEVAS (Q & Owners) ---
        function setQuarterDate(q) {
            const year = new Date().getFullYear();
            let dateStr = '';
            if(q === 1) dateStr = `${year}-03-31`;
            if(q === 2) dateStr = `${year}-06-30`;
            if(q === 3) dateStr = `${year}-09-30`;
            if(q === 4) dateStr = `${year}-12-31`;
            document.getElementById('inp-end').value = dateStr;
        }

        function updateOwnerSuggestions() {
            const container = document.getElementById('owner-suggestions');
            container.innerHTML = '';
            // Combinar recientes + existentes en DB (unicos)
            const dbOwners = [...db.objectives, ...db.projects, ...db.kpis].map(x => x.owner).filter(Boolean);
            const allOwners = [...new Set([...recentOwners, ...dbOwners])].slice(0, 10); // Max 10

            allOwners.forEach(name => {
                const chip = document.createElement('div');
                chip.className = 'owner-chip';
                chip.innerText = name;
                chip.onclick = () => document.getElementById('inp-owner').value = name;
                container.appendChild(chip);
            });
        }

        function renderTags(tags) {
            return tags ? tags.map(t => `<span class="text-[9px] text-slate-400 border border-slate-100 px-1 rounded">${t}</span>`).join('') : '';
        }

        function switchView(view) {
            document.getElementById('view-explorer').classList.toggle('hidden', view !== 'explorer');
            document.getElementById('view-dashboard').classList.toggle('hidden', view !== 'dashboard');
            
            const btnEx = document.getElementById('btn-explorer');
            const btnDb = document.getElementById('btn-dashboard');
            const activeClass = ['bg-indigo-50', 'text-indigo-700', 'font-medium'];
            const inactiveClass = ['hover:bg-slate-50', 'text-slate-500', 'hover:text-slate-900'];
            
            if(view === 'explorer') {
                btnEx.classList.add(...activeClass); btnEx.classList.remove(...inactiveClass);
                btnDb.classList.remove(...activeClass); btnDb.classList.add(...inactiveClass);
            } else {
                btnDb.classList.add(...activeClass); btnDb.classList.remove(...inactiveClass);
                btnEx.classList.remove(...activeClass); btnEx.classList.add(...inactiveClass);
                renderChart();
            }
        }
        
        function renderChart() {
            let counts = { 'A Tiempo': 0, 'Riesgo': 0, 'Retrasado': 0 };
            let total = 0; let count = 0;

            db.objectives.forEach(obj => {
                const m = calculateMetrics(obj, 'objective');
                if (m.label in counts) counts[m.label]++;
                else counts['Retrasado']++;
                total += m.actual; count++;
            });

            document.getElementById('dash-total').innerText = (count ? Math.round(total/count) : 0) + '%';
            document.getElementById('dash-ontrack').innerText = counts['A Tiempo'];
            document.getElementById('dash-atrisk').innerText = counts['Riesgo'];
            document.getElementById('dash-offtrack').innerText = counts['Retrasado'];

            const ctx = document.getElementById('statusChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A Tiempo', 'Riesgo', 'Retrasado'],
                    datasets: [{
                        label: 'Objetivos',
                        data: [counts['A Tiempo'], counts['Riesgo'], counts['Retrasado']],
                        backgroundColor: ['#10b981', '#fbbf24', '#f43f5e'],
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        // Init
        if(API_URL) loadFromGoogle();
        else renderExplorer();
    </script>
</body>
</html>
