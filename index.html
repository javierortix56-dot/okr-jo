<!DOCTYPE html>
<html lang="es" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Manager | Viva Clone v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600;700&display=swap');
        body { font-family: 'Segoe UI', sans-serif; }
        
        /* Estilos Compactos y Clean */
        .glass-card { background: white; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .glass-card:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* Línea de Pacing (Dónde deberías estar) */
        .pacing-marker { position: absolute; top: 0; bottom: 0; border-right: 2px dashed #64748b; z-index: 10; opacity: 0.5; }
        
        /* Colores de Estado */
        .status-on-track { background-color: #10b981; }
        .status-at-risk { background-color: #f59e0b; }
        .status-off-track { background-color: #ef4444; }
        .text-on-track { color: #059669; background-color: #ecfdf5; }
        .text-at-risk { color: #b45309; background-color: #fffbeb; }
        .text-off-track { color: #b91c1c; background-color: #fef2f2; }

        /* Utilidad para ocultar/mostrar con animación */
        .accordion-content { transition: max-height 0.3s ease-in-out; overflow: hidden; }
        .rotate-icon { transition: transform 0.2s; }
        .expanded .rotate-icon { transform: rotate(90deg); }
    </style>
</head>
<body class="text-slate-700 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl flex-shrink-0 z-20">
        <div class="p-5 flex items-center gap-3 font-bold text-white text-lg border-b border-slate-800">
            <i data-lucide="layers" class="text-blue-400"></i>
            <span>OKR Manager <span class="text-xs font-normal opacity-50 ml-1">v2.0</span></span>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1">
            <button onclick="switchView('explorer')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md bg-slate-800 text-white shadow-sm text-sm font-medium transition" id="nav-explorer">
                <i data-lucide="list-tree" size="18"></i> Mis OKRs
            </button>
            <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white text-sm font-medium transition" id="nav-dashboard">
                <i data-lucide="layout-dashboard" size="18"></i> Dashboard
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800">
             <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 text-xs text-slate-400 hover:text-white transition py-2 border border-slate-700 rounded hover:bg-slate-800">
                <i data-lucide="download" size="14"></i> Backup Datos
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#f8fafc] p-6">
        
        <div id="view-explorer" class="max-w-5xl mx-auto space-y-6">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Mis Objetivos</h2>
                    <p class="text-xs text-slate-500">Gestión jerárquica de rendimiento</p>
                </div>
                <button onclick="openModal('objective')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2 text-sm font-semibold transition">
                    <i data-lucide="plus" size="16"></i> Nuevo Objetivo
                </button>
            </header>

            <div id="tree-container" class="space-y-4">
                </div>
        </div>

        <div id="view-dashboard" class="hidden max-w-5xl mx-auto space-y-6">
             <header>
                <h2 class="text-2xl font-bold text-slate-800">Resumen Ejecutivo</h2>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="glass-card p-6 rounded-lg flex flex-col items-center justify-center bg-white shadow-sm">
                    <span class="text-xs text-slate-500 font-bold uppercase tracking-wider">Avance Global</span>
                    <div id="dash-global-progress" class="text-4xl font-bold text-blue-600 mt-2">0%</div>
                </div>
                <div class="glass-card p-6 rounded-lg md:col-span-2 flex items-center justify-around bg-white shadow-sm">
                    <div class="h-32 w-32">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="space-y-2 text-xs font-medium">
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#10b981]"></span> On Track</div>
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#f59e0b]"></span> At Risk</div>
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#ef4444]"></span> Off Track</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-black/30 backdrop-blur-[2px] hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">Crear Elemento</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" size="20"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <input type="hidden" id="parent-id">
                <input type="hidden" id="entity-type">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Título</label>
                    <input id="inp-title" type="text" class="w-full p-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Escribe el nombre...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Responsable</label>
                        <input id="inp-owner" type="text" class="w-full p-2 text-sm border border-slate-300 rounded" placeholder="Ej: JP">
                    </div>
                    <div id="field-tags">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Etiqueta</label>
                        <input id="inp-tags" type="text" class="w-full p-2 text-sm border border-slate-300 rounded" placeholder="Ej: Q1, Venta">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Inicio</label>
                        <input id="inp-start-date" type="date" class="w-full p-2 text-sm border border-slate-300 rounded text-slate-600">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fin</label>
                        <input id="inp-end-date" type="date" class="w-full p-2 text-sm border border-slate-300 rounded text-slate-600">
                    </div>
                </div>

                <div id="field-metrics" class="hidden bg-blue-50 p-3 rounded border border-blue-100 grid grid-cols-2 gap-3">
                     <div class="col-span-2 text-xs font-bold text-blue-800 flex items-center gap-1"><i data-lucide="hash" size="12"></i> Métricas Numéricas</div>
                     <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Inicial</label>
                        <input id="inp-val-start" type="number" class="w-full p-1.5 text-sm border border-slate-300 rounded bg-white">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Meta</label>
                        <input id="inp-val-target" type="number" class="w-full p-1.5 text-sm border border-slate-300 rounded bg-white font-bold text-blue-700">
                    </div>
                </div>
            </div>

            <div class="px-6 py-3 bg-slate-50 flex justify-end gap-2 border-t">
                <button onclick="closeModal()" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-200 rounded transition">Cancelar</button>
                <button onclick="saveEntity()" class="px-4 py-2 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm transition">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // 1. BASE DE DATOS LOCAL
        let db = JSON.parse(localStorage.getItem('okr_v2_db')) || { objectives: [], projects: [], kpis: [] };
        let chartInstance = null;

        // 2. COLORES PARA ETIQUETAS (Pasteles)
        const tagColors = [
            'bg-blue-100 text-blue-700 border-blue-200',
            'bg-green-100 text-green-700 border-green-200',
            'bg-purple-100 text-purple-700 border-purple-200',
            'bg-orange-100 text-orange-700 border-orange-200',
            'bg-pink-100 text-pink-700 border-pink-200'
        ];

        function getTagClass(text) {
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
            const index = Math.abs(hash) % tagColors.length;
            return tagColors[index];
        }

        // 3. LÓGICA DE CÁLCULO
        function calculateMetrics(item, type) {
            const now = new Date();
            const start = new Date(item.startDate);
            const end = new Date(item.endDate);
            const totalTime = Math.max(1, end - start);
            const elapsed = Math.max(0, now - start);
            
            // Pacing
            let pacing = (elapsed / totalTime) * 100;
            pacing = Math.min(100, Math.max(0, pacing));

            if (type === 'kpi') {
                let actual = 0;
                if (item.targetValue > item.startValue) {
                    actual = ((item.currentValue - item.startValue) / (item.targetValue - item.startValue)) * 100;
                }
                actual = Math.min(100, Math.max(0, actual));
                return getStatusObj(actual, pacing);
            }

            // Para padres (Objetivos y Proyectos): Promedio de hijos
            let childrenMetrics = [];
            
            // Si es Objetivo, busca Proyectos Y KPIs directos
            if (type === 'objective') {
                const childProjs = db.projects.filter(p => p.objectiveId === item.id);
                const childKpis = db.kpis.filter(k => k.objectiveId === item.id); // KPIs directos
                
                // Recursión: Calcular métricas de Proyectos hijos
                const projMetrics = childProjs.map(p => calculateMetrics(p, 'project'));
                const kpiMetrics = childKpis.map(k => calculateMetrics(k, 'kpi'));
                
                childrenMetrics = [...projMetrics, ...kpiMetrics];
            } 
            // Si es Proyecto, solo busca KPIs
            else if (type === 'project') {
                const childKpis = db.kpis.filter(k => k.projectId === item.id);
                childrenMetrics = childKpis.map(k => calculateMetrics(k, 'kpi'));
            }

            if (childrenMetrics.length === 0) return { actual: 0, pacing: 0, css: 'status-off-track', label: 'Sin Definir', textCss: 'text-gray-500 bg-gray-100' };

            const avgActual = childrenMetrics.reduce((sum, m) => sum + m.actual, 0) / childrenMetrics.length;
            const maxPacing = Math.max(...childrenMetrics.map(m => m.pacing)); // Tomamos el pacing más exigente o promedio
            
            return getStatusObj(avgActual, maxPacing);
        }

        function getStatusObj(actual, pacing) {
            let css = 'status-off-track';
            let textCss = 'text-off-track';
            let label = 'Retrasado';

            if (pacing < 5) { // Periodo de gracia al inicio
                css = 'status-on-track'; textCss = 'text-on-track'; label = 'A Tiempo';
            } else {
                const ratio = actual / pacing;
                if (ratio >= 0.9) { css = 'status-on-track'; textCss = 'text-on-track'; label = 'A Tiempo'; }
                else if (ratio >= 0.7) { css = 'status-at-risk'; textCss = 'text-at-risk'; label = 'Riesgo'; }
            }
            return { actual: Math.round(actual), pacing: Math.round(pacing), css, textCss, label };
        }

        // 4. RENDERIZADO (Diseño Compacto y Acordeón)
        function renderTree() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            let globalSum = 0; let globalCount = 0;
            let statusCounts = { 'A Tiempo': 0, 'Riesgo': 0, 'Retrasado': 0 };

            if (db.objectives.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-slate-400 border-2 border-dashed border-slate-200 rounded-lg text-sm">No tienes objetivos. Crea uno nuevo arriba.</div>`;
                updateDashboard(0, { 'A Tiempo':0, 'Riesgo':0, 'Retrasado':0 });
                return;
            }

            db.objectives.forEach(obj => {
                // Métricas del Objetivo
                const metrics = calculateMetrics(obj, 'objective');
                globalSum += metrics.actual; if(metrics.actual > 0 || hasChildren(obj.id)) globalCount++;
                statusCounts[metrics.label]++;

                // Hijos: Proyectos y KPIs directos
                const projects = db.projects.filter(p => p.objectiveId === obj.id);
                const directKpis = db.kpis.filter(k => k.objectiveId === obj.id);

                // Render HTML Hijos
                let childrenHTML = '';
                
                // 1. KPIs Directos
                directKpis.forEach(k => {
                    const m = calculateMetrics(k, 'kpi');
                    childrenHTML += renderRowHTML('kpi', k, m, true);
                });

                // 2. Proyectos
                projects.forEach(p => {
                    const m = calculateMetrics(p, 'project');
                    const pKpis = db.kpis.filter(k => k.projectId === p.id);
                    
                    let projChildrenHTML = '';
                    pKpis.forEach(pk => {
                         const pm = calculateMetrics(pk, 'kpi');
                         projChildrenHTML += renderRowHTML('kpi', pk, pm, true); // Indented
                    });

                    childrenHTML += `
                        <div class="mt-2 ml-4 pl-3 border-l-2 border-slate-100">
                            ${renderRowHTML('project', p, m, false)}
                            <div class="mt-1 space-y-1">
                                ${projChildrenHTML}
                            </div>
                        </div>
                    `;
                });

                // Render Objetivo Card (Padre)
                const expandedClass = 'expanded'; // Por defecto expandido
                const objHTML = `
                    <div class="glass-card rounded-lg bg-white mb-4 group overflow-hidden" id="node-${obj.id}">
                        <div class="p-3 flex items-start gap-3 cursor-pointer select-none hover:bg-slate-50 transition" onclick="toggleNode(${obj.id})">
                            <div class="mt-1 text-slate-400 rotate-icon"><i data-lucide="chevron-right" size="18"></i></div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="target" class="text-blue-600" size="18"></i>
                                        <h3 class="font-bold text-slate-800 text-base leading-tight">${obj.title}</h3>
                                        ${renderTags(obj.tags)}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-[10px] font-bold px-2 py-0.5 rounded ${metrics.textCss}">${metrics.label}</div>
                                        <div class="w-6 h-6 rounded-full bg-slate-200 text-[10px] flex items-center justify-center font-bold text-slate-600" title="${obj.owner}">${getInitials(obj.owner)}</div>
                                    </div>
                                </div>
                                <div class="mt-2 flex items-center gap-3">
                                    <div class="flex-1 h-2 bg-slate-100 rounded-full relative overflow-hidden">
                                        <div class="pacing-marker" style="left: ${metrics.pacing}%"></div>
                                        <div class="${metrics.css} h-full rounded-full" style="width: ${metrics.actual}%"></div>
                                    </div>
                                    <span class="text-xs font-bold text-slate-700 w-8 text-right">${metrics.actual}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="px-3 py-1 bg-slate-50 border-t border-slate-100 flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                             <button onclick="openModal('project', ${obj.id})" class="text-[10px] font-bold text-slate-500 hover:text-blue-600 flex items-center gap-1 bg-white border px-2 py-0.5 rounded hover:border-blue-300 transition">
                                <i data-lucide="folder-plus" size="12"></i> Proyecto
                            </button>
                            <button onclick="openModal('kpi', ${obj.id}, 'objective')" class="text-[10px] font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1 bg-white border px-2 py-0.5 rounded hover:border-indigo-300 transition">
                                <i data-lucide="bar-chart-2" size="12"></i> KPI Directo
                            </button>
                        </div>

                        <div id="children-${obj.id}" class="accordion-content bg-slate-50/50 p-2 pt-0" style="max-height: 2000px;">
                            <div class="pl-2 pr-1 pb-2">
                                ${childrenHTML || '<div class="text-[10px] text-slate-400 italic pl-8 py-2">Sin resultados clave ni proyectos.</div>'}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += objHTML;
                
                // Asegurar estado inicial del icono acordeón
                setTimeout(() => document.getElementById(`node-${obj.id}`).classList.add('expanded'), 0);
            });

            updateDashboard(globalCount ? Math.round(globalSum/globalCount) : 0, statusCounts);
            lucide.createIcons();
        }

        // Renderizado de Filas (Proyecto o KPI)
        function renderRowHTML(type, item, metrics, isIndented) {
            const isKpi = type === 'kpi';
            const icon = isKpi ? '<i data-lucide="hash" size="14" class="text-slate-400"></i>' : '<i data-lucide="folder-kanban" size="14" class="text-indigo-500"></i>';
            const bgClass = isKpi ? 'bg-white' : 'bg-slate-100';
            const marginClass = isKpi ? 'my-1' : 'my-2';
            
            // Input valor para KPI
            const valInput = isKpi ? `
                <input type="number" value="${item.currentValue}" onchange="updateVal(${item.id}, this.value)" 
                class="w-16 text-right text-xs p-0.5 border rounded bg-slate-50 font-mono text-slate-700 focus:ring-1 focus:ring-blue-500 outline-none" title="Actual / Meta: ${item.targetValue}">
                <span class="text-[10px] text-slate-400">/ ${item.targetValue}</span>
            ` : '';

            // Botón añadir hijo solo para Proyecto
            const addBtn = !isKpi ? `
                <button onclick="openModal('kpi', ${item.id}, 'project')" class="ml-2 text-[10px] text-indigo-400 hover:text-indigo-700 bg-white border border-indigo-100 px-1.5 rounded transition">
                    + KPI
                </button>
            ` : '';

            return `
            <div class="flex items-center gap-3 p-2 rounded border border-slate-100 ${bgClass} ${marginClass} hover:border-slate-300 transition group relative">
                <div class="mt-0.5">${icon}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-sm font-medium text-slate-700 truncate">${item.title}</span>
                            ${renderTags(item.tags)}
                            ${addBtn}
                        </div>
                        <div class="flex items-center gap-2">
                            ${valInput}
                             <div class="w-5 h-5 rounded-full bg-white border border-slate-200 text-[9px] flex items-center justify-center text-slate-500" title="${item.owner}">${getInitials(item.owner)}</div>
                        </div>
                    </div>
                    <div class="mt-1.5 flex items-center gap-2 h-1.5 bg-slate-200 rounded-full w-full relative overflow-hidden">
                        <div class="pacing-marker" style="left: ${metrics.pacing}%"></div>
                        <div class="${metrics.css} h-full rounded-full" style="width: ${metrics.actual}%"></div>
                    </div>
                </div>
                <div class="text-[10px] font-bold w-6 text-right ${metrics.textCss.split(' ')[0]}">${metrics.actual}%</div>
            </div>
            `;
        }

        // 5. INTERACCIONES UI
        function toggleNode(id) {
            const node = document.getElementById(`node-${id}`);
            const content = document.getElementById(`children-${id}`);
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null; // Colapsar
                node.classList.remove('expanded');
            } else {
                content.style.maxHeight = content.scrollHeight + "px"; // Expandir
                node.classList.add('expanded');
            }
        }

        function renderTags(tags) {
            if (!tags || tags.length === 0) return '';
            return tags.map(t => `<span class="text-[9px] px-1.5 py-0.5 rounded border ${getTagClass(t)} font-bold uppercase tracking-wide">${t}</span>`).join('');
        }

        function updateVal(id, val) {
            const k = db.kpis.find(x => x.id === id);
            if (k) { k.currentValue = parseFloat(val); saveData(); renderTree(); }
        }

        // Modales y Guardado
        let currentParentContext = null; // 'objective' o 'project'

        function openModal(type, parentId = null, context = null) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('entity-type').value = type;
            document.getElementById('parent-id').value = parentId || '';
            currentParentContext = context; // Guardamos si el KPI es para Obj o Proj

            const isKpi = type === 'kpi';
            document.getElementById('modal-title').innerText = isKpi ? 'Nuevo KPI' : (type === 'project' ? 'Nuevo Proyecto' : 'Nuevo Objetivo');
            document.getElementById('field-tags').classList.toggle('hidden', isKpi);
            document.getElementById('field-metrics').classList.toggle('hidden', !isKpi);
            
            // Fechas default
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('inp-start-date').value = d;
            document.getElementById('inp-end-date').value = d;
            
            // Limpiar
            ['inp-title','inp-owner','inp-tags','inp-val-start','inp-val-target'].forEach(id => document.getElementById(id).value = '');
        }

        function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }

        function saveEntity() {
            const type = document.getElementById('entity-type').value;
            const pid = parseInt(document.getElementById('parent-id').value);
            const title = document.getElementById('inp-title').value;
            if(!title) return;

            const base = {
                id: Date.now(),
                title,
                owner: document.getElementById('inp-owner').value,
                startDate: document.getElementById('inp-start-date').value,
                endDate: document.getElementById('inp-end-date').value
            };

            if (type === 'objective') {
                base.tags = parseTags(document.getElementById('inp-tags').value);
                db.objectives.push(base);
            } else if (type === 'project') {
                base.objectiveId = pid;
                base.tags = parseTags(document.getElementById('inp-tags').value);
                db.projects.push(base);
            } else if (type === 'kpi') {
                base.startValue = parseFloat(document.getElementById('inp-val-start').value) || 0;
                base.targetValue = parseFloat(document.getElementById('inp-val-target').value) || 100;
                base.currentValue = base.startValue;
                
                // ASIGNACIÓN INTELIGENTE: ¿Es hijo de Objetivo o de Proyecto?
                if (currentParentContext === 'objective') {
                    base.objectiveId = pid; // KPI directo al objetivo
                } else {
                    base.projectId = pid; // KPI de proyecto
                }
                db.kpis.push(base);
            }

            saveData(); closeModal(); renderTree();
        }

        // Helpers
        function saveData() { localStorage.setItem('okr_v2_db', JSON.stringify(db)); }
        function parseTags(str) { return str ? str.split(',').map(s=>s.trim()).filter(s=>s) : []; }
        function getInitials(n) { return n ? n.split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase() : '?'; }
        function hasChildren(oid) {
            return db.projects.some(p=>p.objectiveId===oid) || db.kpis.some(k=>k.objectiveId===oid);
        }
        function exportData() {
            const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = s; a.download = "okr_data.json"; a.click();
        }
        function switchView(v) {
            document.getElementById('view-explorer').classList.toggle('hidden', v !== 'explorer');
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('nav-explorer').className = v === 'explorer' ? 'w-full flex items-center gap-3 px-3 py-2 rounded-md bg-slate-800 text-white shadow-sm text-sm font-medium transition' : 'w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white text-sm font-medium transition';
            document.getElementById('nav-dashboard').className = v === 'dashboard' ? 'w-full flex items-center gap-3 px-3 py-2 rounded-md bg-slate-800 text-white shadow-sm text-sm font-medium transition' : 'w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-800 hover:text-white text-sm font-medium transition';
        }
        function updateDashboard(val, counts) {
            document.getElementById('dash-global-progress').innerText = val + '%';
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts), backgroundColor: ['#10b981','#f59e0b','#ef4444'], borderWidth: 0 }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        // Init
        renderTree();
    </script>
</body>
</html>
