<!DOCTYPE html>
<html lang="es" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Manager v3 | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* UI Components */
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .glass-panel:hover { border-color: #cbd5e1; }
        
        .pacing-line { position: absolute; top: 0; bottom: 0; border-right: 2px dashed #94a3b8; z-index: 10; opacity: 0.5; }
        
        /* Status Colors */
        .badge-on-track { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-at-risk { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .badge-off-track { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }

        /* KPI Badge */
        .kpi-badge { background: #eff6ff; color: #1d4ed8; font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; border: 1px solid #bfdbfe; letter-spacing: 0.05em; }

        /* Collapse Logic */
        .node-content { transition: all 0.2s ease-in-out; }
        .node-content.hidden { display: none; }
        .rotate-90 { transform: rotate(90deg); }
        .arrow-icon { transition: transform 0.2s; }
    </style>
</head>
<body class="text-slate-700 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 z-30">
        <div class="p-5 flex items-center gap-3 font-bold text-white text-lg border-b border-slate-800">
            <div class="bg-blue-600 p-1 rounded"><i data-lucide="target" class="text-white" size="20"></i></div>
            <span>OKR v3 <span class="text-[10px] uppercase text-slate-500 ml-1">Pro</span></span>
        </div>
        <nav class="flex-1 px-3 py-6 space-y-2">
            <button onclick="switchView('explorer')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg bg-slate-800 text-white shadow transition" id="btn-explorer">
                <i data-lucide="list-tree" size="18"></i> Mis OKRs
            </button>
            <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition" id="btn-dashboard">
                <i data-lucide="layout-dashboard" size="18"></i> Dashboard
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800">
             <button onclick="exportData()" class="w-full py-2 text-xs text-slate-400 hover:text-white border border-slate-700 rounded hover:bg-slate-800 transition flex justify-center gap-2">
                <i data-lucide="save" size="14"></i> Guardar Backup
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#f1f5f9] p-8">
        
        <div id="view-explorer" class="max-w-6xl mx-auto">
            <header class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Mis Objetivos</h1>
                    <p class="text-slate-500 mt-1">Gestión ponderada de Objetivos, Proyectos y Tareas.</p>
                </div>
                <button onclick="openModal('objective')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-lg shadow-blue-600/20 flex items-center gap-2 font-medium transition transform hover:-translate-y-0.5">
                    <i data-lucide="plus" size="18"></i> Nuevo Objetivo
                </button>
            </header>

            <div id="tree-container" class="space-y-6">
                </div>
        </div>

        <div id="view-dashboard" class="hidden max-w-7xl mx-auto space-y-8">
            <header>
                <h1 class="text-3xl font-bold text-slate-800">Tablero de Mando</h1>
                <p class="text-slate-500">Resumen ejecutivo del periodo</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-panel p-6 rounded-xl bg-white flex flex-col justify-between h-32 border-l-4 border-blue-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">Progreso Total</span>
                    <div class="text-4xl font-black text-slate-800" id="dash-total">0%</div>
                </div>
                <div class="glass-panel p-6 rounded-xl bg-white flex flex-col justify-between h-32 border-l-4 border-emerald-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">A Tiempo</span>
                    <div class="text-4xl font-black text-emerald-600" id="dash-ontrack">0</div>
                </div>
                <div class="glass-panel p-6 rounded-xl bg-white flex flex-col justify-between h-32 border-l-4 border-amber-400">
                    <span class="text-xs font-bold text-slate-400 uppercase">En Riesgo</span>
                    <div class="text-4xl font-black text-amber-500" id="dash-atrisk">0</div>
                </div>
                <div class="glass-panel p-6 rounded-xl bg-white flex flex-col justify-between h-32 border-l-4 border-rose-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">Retrasados</span>
                    <div class="text-4xl font-black text-rose-600" id="dash-offtrack">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="glass-panel p-6 rounded-xl bg-white lg:col-span-1">
                    <h3 class="font-bold text-slate-700 mb-4">Distribución de Salud</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="glass-panel p-6 rounded-xl bg-white lg:col-span-2 overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-4">Desglose de Objetivos</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3">Objetivo</th>
                                    <th class="px-4 py-3">Dueño</th>
                                    <th class="px-4 py-3">Peso</th>
                                    <th class="px-4 py-3 text-right">Avance</th>
                                    <th class="px-4 py-3 text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="dash-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">Configurar Elemento</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            
            <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="edit-id"> <input type="hidden" id="parent-id">
                <input type="hidden" id="entity-type">
                <input type="hidden" id="context-type"> <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Título</label>
                    <input id="inp-title" type="text" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Responsable</label>
                        <input id="inp-owner" type="text" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Ej: Juan Perez">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 flex justify-between">
                            Peso (Importancia) <span class="text-slate-400 text-[10px] font-normal">1-10</span>
                        </label>
                        <input id="inp-weight" type="number" min="1" max="10" value="1" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm font-mono">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Inicio</label>
                        <input id="inp-start" type="date" class="w-full p-2 text-sm border rounded bg-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fin (Deadline)</label>
                        <input id="inp-end" type="date" class="w-full p-2 text-sm border rounded bg-white">
                    </div>
                </div>
                
                <div id="field-metrics" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100 grid grid-cols-2 gap-4">
                     <div class="col-span-2 text-xs font-bold text-blue-800">Configuración Numérica (KPI)</div>
                     <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Valor Inicial</label>
                        <input id="inp-val-start" type="number" class="w-full p-2 text-sm border border-blue-200 rounded text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Objetivo (Meta)</label>
                        <input id="inp-val-target" type="number" class="w-full p-2 text-sm border border-blue-200 rounded font-bold text-blue-700 text-center">
                    </div>
                </div>

                <div id="field-tags">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Etiquetas (Separadas por coma)</label>
                    <input id="inp-tags" type="text" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Q1, Estrategico...">
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t flex justify-end gap-3 rounded-b-xl">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-200 rounded transition">Cancelar</button>
                <button onclick="saveDataFromModal()" class="px-6 py-2 text-sm font-bold bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        /* ----------------------------------------------------
           1. ESTRUCTURA DE DATOS & STATE
           ---------------------------------------------------- */
        const DB_KEY = 'okr_v3_master_db';
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || { 
            objectives: [], 
            projects: [], 
            kpis: [], 
            tasks: [] // Nueva entidad: Tareas
        };

        /* ----------------------------------------------------
           2. MOTOR DE CÁLCULO (PONDERADO)
           ---------------------------------------------------- */
        
        // Calcula métricas de un item individual
        function calculateMetrics(item, type) {
            const now = new Date();
            const start = new Date(item.startDate);
            const end = new Date(item.endDate);
            const totalDays = Math.max(1, (end - start) / (1000 * 60 * 60 * 24));
            const elapsedDays = Math.max(0, (now - start) / (1000 * 60 * 60 * 24));
            
            // Pacing
            let pacing = (elapsedDays / totalDays) * 100;
            pacing = Math.min(100, Math.max(0, pacing));

            // Caso KPI: Cálculo directo numérico
            if (type === 'kpi') {
                let actual = 0;
                if (item.targetValue > item.startValue) {
                    actual = ((item.currentValue - item.startValue) / (item.targetValue - item.startValue)) * 100;
                }
                actual = Math.min(100, Math.max(0, actual));
                return getStatusObject(actual, pacing);
            }

            // Caso Contenedores (Obj y Proj): Promedio Ponderado de hijos
            let childrenMetrics = [];
            
            // Buscar KPIs hijos
            const childKpis = db.kpis.filter(k => 
                (type === 'objective' && k.objectiveId === item.id && !k.projectId) || 
                (type === 'project' && k.projectId === item.id)
            );
            childKpis.forEach(k => {
                const m = calculateMetrics(k, 'kpi');
                childrenMetrics.push({ progress: m.actual, weight: k.weight || 1, pacing: m.pacing });
            });

            // Si es objetivo, buscar Proyectos hijos
            if (type === 'objective') {
                const childProjs = db.projects.filter(p => p.objectiveId === item.id);
                childProjs.forEach(p => {
                    const m = calculateMetrics(p, 'project');
                    childrenMetrics.push({ progress: m.actual, weight: p.weight || 1, pacing: m.pacing });
                });
            }

            // Si es Proyecto, buscar Tareas hijas
            if (type === 'project') {
                const childTasks = db.tasks.filter(t => t.projectId === item.id);
                childTasks.forEach(t => {
                    childrenMetrics.push({ 
                        progress: t.done ? 100 : 0, 
                        weight: 1, // Tareas pesan 1 por defecto por ahora
                        pacing: pacing // Tareas asumen pacing del padre
                    });
                });
            }

            if (childrenMetrics.length === 0) {
                return { actual: 0, pacing: 0, css: 'bg-gray-100 text-gray-400', label: 'Nuevo' };
            }

            // Fórmula Promedio Ponderado
            const totalWeight = childrenMetrics.reduce((sum, c) => sum + parseFloat(c.weight), 0);
            const weightedSum = childrenMetrics.reduce((sum, c) => sum + (c.progress * parseFloat(c.weight)), 0);
            const avgActual = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
            const maxPacing = Math.max(...childrenMetrics.map(c => c.pacing));

            return getStatusObject(avgActual, maxPacing);
        }

        function getStatusObject(actual, pacing) {
            let label = 'Retrasado';
            let css = 'badge-off-track';
            
            if (pacing < 10) { 
                label = 'Inicio'; css = 'badge-on-track'; 
            } else {
                const ratio = actual / pacing;
                if (ratio >= 0.9) { label = 'A Tiempo'; css = 'badge-on-track'; }
                else if (ratio >= 0.7) { label = 'En Riesgo'; css = 'badge-at-risk'; }
            }
            return { actual: Math.round(actual), pacing: Math.round(pacing), css, label };
        }


        /* ----------------------------------------------------
           3. RENDERIZADO (UI)
           ---------------------------------------------------- */
        
        function renderExplorer() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            
            if(db.objectives.length === 0) {
                container.innerHTML = `<div class="text-center py-12 bg-white rounded border border-dashed text-slate-400">No hay datos. Crea tu primer objetivo.</div>`;
                return;
            }

            db.objectives.forEach(obj => {
                const m = calculateMetrics(obj, 'objective');
                
                // Render Hijos
                const projects = db.projects.filter(p => p.objectiveId === obj.id);
                const directKpis = db.kpis.filter(k => k.objectiveId === obj.id && !k.projectId);
                
                let childrenHtml = '';
                
                // KPIs Directos
                directKpis.forEach(k => {
                    const km = calculateMetrics(k, 'kpi');
                    childrenHtml += renderRow('kpi', k, km);
                });

                // Proyectos
                projects.forEach(p => {
                    const pm = calculateMetrics(p, 'project');
                    const pKpis = db.kpis.filter(k => k.projectId === p.id);
                    const pTasks = db.tasks.filter(t => t.projectId === p.id);

                    let projContent = '';
                    
                    // Tasks List
                    if(pTasks.length > 0) {
                        projContent += `<div class="mt-2 mb-2 space-y-1">`;
                        pTasks.forEach(t => {
                            projContent += `
                                <div class="flex items-center gap-2 text-xs ml-1">
                                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})" class="accent-blue-600 cursor-pointer">
                                    <span class="${t.done ? 'line-through text-slate-400' : 'text-slate-600'}">${t.title}</span>
                                    <button onclick="deleteTask(${t.id})" class="text-slate-300 hover:text-red-500 ml-auto"><i data-lucide="trash-2" size="10"></i></button>
                                </div>`;
                        });
                        projContent += `</div>`;
                    }

                    // Project KPIs
                    pKpis.forEach(pk => {
                         const pkm = calculateMetrics(pk, 'kpi');
                         projContent += renderRow('kpi', pk, pkm);
                    });
                    
                    // Input nueva tarea
                    const taskInput = `
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="new-task-${p.id}" placeholder="+ Nueva tarea..." class="text-xs border p-1 rounded w-full focus:outline-blue-500" 
                            onkeydown="if(event.key==='Enter') addTask(${p.id})">
                        </div>
                    `;

                    childrenHtml += `
                        <div class="ml-4 pl-4 border-l-2 border-slate-200 mt-2 mb-3">
                            ${renderRow('project', p, pm)}
                            <div class="pl-2 pr-1 mt-1">
                                ${projContent}
                                ${taskInput}
                            </div>
                        </div>
                    `;
                });

                // Card Principal (Objetivo)
                const card = `
                <div class="glass-panel bg-white rounded-lg mb-6 overflow-hidden">
                    <div class="p-4 flex items-start gap-3 select-none">
                        <button onclick="toggleCollapse(${obj.id})" class="mt-1 text-slate-400 hover:text-blue-600 arrow-icon" id="arrow-${obj.id}">
                            <i data-lucide="chevron-right" size="20"></i>
                        </button>
                        
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="target" class="text-blue-600" size="18"></i>
                                        <h3 class="font-bold text-lg text-slate-800">${obj.title}</h3>
                                        <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">Peso: ${obj.weight || 1}</span>
                                        ${renderTags(obj.tags)}
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1 flex gap-3">
                                        <span class="flex items-center gap-1"><i data-lucide="user" size="12"></i> ${obj.owner || 'N/A'}</span>
                                        <span class="flex items-center gap-1"><i data-lucide="calendar" size="12"></i> ${obj.endDate}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="${m.css} px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">${m.label}</div>
                                    <div class="flex gap-1">
                                         <button onclick="openEdit('objective', ${obj.id})" class="p-1 text-slate-300 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Editar">
                                            <i data-lucide="pencil" size="14"></i>
                                        </button>
                                        <button onclick="openModal('project', ${obj.id}, 'objective')" class="text-xs bg-slate-50 border hover:bg-white px-2 py-1 rounded flex items-center gap-1 text-slate-600 font-medium transition">
                                            <i data-lucide="folder-plus" size="12"></i> Proyecto
                                        </button>
                                        <button onclick="openModal('kpi', ${obj.id}, 'objective')" class="text-xs bg-slate-50 border hover:bg-white px-2 py-1 rounded flex items-center gap-1 text-slate-600 font-medium transition">
                                            <i data-lucide="plus" size="12"></i> KPI
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center gap-3">
                                <div class="flex-1 h-3 bg-slate-100 rounded-full relative overflow-hidden">
                                    <div class="pacing-line" style="left: ${m.pacing}%"></div>
                                    <div class="${m.css.replace('badge-', 'bg-').replace('border-', '')} h-full rounded-full transition-all duration-500" 
                                    style="width: ${m.actual}%; background-color: currentColor; opacity: 0.8"></div>
                                </div>
                                <span class="font-bold text-sm text-slate-700 w-8 text-right">${m.actual}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content-${obj.id}" class="bg-slate-50 border-t border-slate-100 p-2 node-content hidden">
                        ${childrenHtml || '<div class="text-xs text-slate-400 text-center py-2">Sin elementos asociados</div>'}
                    </div>
                </div>`;
                
                container.innerHTML += card;
                // Auto-expandir por defecto
                setTimeout(() => toggleCollapse(obj.id), 0);
            });
            lucide.createIcons();
        }

        function renderRow(type, item, m) {
            const isKpi = type === 'kpi';
            const icon = isKpi ? '<span class="kpi-badge">KPI</span>' : '<i data-lucide="folder-kanban" class="text-indigo-500" size="16"></i>';
            const bg = isKpi ? 'bg-white border-slate-200' : 'bg-indigo-50/50 border-indigo-100';
            
            // Input numérico para KPI
            const valInput = isKpi ? `
                <div class="flex items-center gap-1 bg-slate-50 px-1 py-0.5 rounded border border-slate-200">
                    <input type="number" value="${item.currentValue}" onchange="updateKpiVal(${item.id}, this.value)" 
                    class="w-14 text-right bg-transparent text-xs font-mono font-bold focus:outline-none text-slate-700">
                    <span class="text-[10px] text-slate-400">/ ${item.targetValue}</span>
                </div>
            ` : '';

            // Botón añadir hijo a Proyecto
            const addBtn = !isKpi ? `
                <button onclick="openModal('kpi', ${item.id}, 'project')" class="text-[10px] text-indigo-600 hover:bg-indigo-100 px-1.5 py-0.5 rounded transition">
                    + KPI
                </button>
            ` : '';

            return `
            <div class="flex items-center gap-3 p-2 mb-1 rounded border ${bg} hover:shadow-sm transition group">
                <div class="flex-shrink-0 w-8 flex justify-center">${icon}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-slate-700 truncate cursor-pointer hover:text-blue-600" onclick="openEdit('${type}', ${item.id})">${item.title}</span>
                             <span class="text-[9px] bg-white border px-1 rounded text-slate-400" title="Peso">w:${item.weight || 1}</span>
                            ${renderTags(item.tags)}
                            ${addBtn}
                        </div>
                        <div class="flex items-center gap-3">
                            ${valInput}
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] font-bold ${m.css} px-1.5 rounded">${m.label}</span>
                                <span class="text-xs font-bold text-slate-700 w-8 text-right">${m.actual}%</span>
                            </div>
                            <button onclick="openEdit('${type}', ${item.id})" class="text-slate-300 hover:text-blue-600 opacity-0 group-hover:opacity-100"><i data-lucide="pencil" size="12"></i></button>
                        </div>
                    </div>
                    <div class="h-1.5 bg-slate-200/50 rounded-full w-full relative overflow-hidden">
                        <div class="pacing-line" style="left: ${m.pacing}%"></div>
                        <div class="h-full rounded-full ${m.css.replace('badge-', 'bg-').replace('border-', '')} opacity-70" style="width: ${m.actual}%; background-color: currentColor;"></div>
                    </div>
                </div>
            </div>`;
        }

        /* ----------------------------------------------------
           4. GESTIÓN DE ESTADO (CRUD)
           ---------------------------------------------------- */
        
        function toggleCollapse(id) {
            const el = document.getElementById(`content-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                arrow.classList.add('rotate-90');
            } else {
                el.classList.add('hidden');
                arrow.classList.remove('rotate-90');
            }
        }

        function updateKpiVal(id, val) {
            const k = db.kpis.find(x => x.id === id);
            if(k) { k.currentValue = parseFloat(val); saveDb(); renderExplorer(); }
        }

        function toggleTask(id) {
            const t = db.tasks.find(x => x.id === id);
            if(t) { t.done = !t.done; saveDb(); renderExplorer(); }
        }
        
        function addTask(projId) {
            const input = document.getElementById(`new-task-${projId}`);
            const title = input.value;
            if(!title) return;
            db.tasks.push({ id: Date.now(), projectId: projId, title, done: false });
            saveDb(); renderExplorer();
        }

        function deleteTask(id) {
            if(confirm('¿Borrar tarea?')) {
                db.tasks = db.tasks.filter(t => t.id !== id);
                saveDb(); renderExplorer();
            }
        }

        // --- MODAL DE EDICIÓN ---
        function openEdit(type, id) {
            const item = type === 'objective' ? db.objectives.find(x=>x.id===id) : 
                         type === 'project' ? db.projects.find(x=>x.id===id) : 
                         db.kpis.find(x=>x.id===id);
            
            if(!item) return;

            // Llenar Modal
            openModal(type, item.parentTypeId || null, item.parentContext || null); // Abre modal base
            document.getElementById('modal-title').innerText = "Editar " + type.toUpperCase();
            document.getElementById('edit-id').value = id; // Flag de edición
            
            // Rellenar campos
            document.getElementById('inp-title').value = item.title;
            document.getElementById('inp-owner').value = item.owner || '';
            document.getElementById('inp-weight').value = item.weight || 1;
            document.getElementById('inp-start').value = item.startDate;
            document.getElementById('inp-end').value = item.endDate;
            document.getElementById('inp-tags').value = item.tags ? item.tags.join(', ') : '';

            if (type === 'kpi') {
                document.getElementById('inp-val-start').value = item.startValue;
                document.getElementById('inp-val-target').value = item.targetValue;
            }
        }

        function openModal(type, parentId, context) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('edit-id').value = ''; // Reset flag edición
            
            document.getElementById('entity-type').value = type;
            document.getElementById('parent-id').value = parentId || '';
            document.getElementById('context-type').value = context || '';

            // Títulos y visibilidad
            const titles = { 'objective': 'Nuevo Objetivo', 'project': 'Nuevo Proyecto', 'kpi': 'Nuevo KPI' };
            document.getElementById('modal-title').innerText = titles[type];
            document.getElementById('field-metrics').classList.toggle('hidden', type !== 'kpi');
            
            // Defaults (solo si es nuevo)
            if (!document.getElementById('edit-id').value) {
                const d = new Date().toISOString().split('T')[0];
                document.getElementById('inp-start').value = d;
                document.getElementById('inp-end').value = d;
                ['inp-title','inp-owner','inp-tags','inp-val-start','inp-val-target'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('inp-weight').value = 1;
            }
        }

        function closeModal() { document.getElementById('modal-backdrop').classList.add('hidden'); }

        function saveDataFromModal() {
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('entity-type').value;
            const title = document.getElementById('inp-title').value;
            
            if(!title) return alert("Título requerido");

            const commonData = {
                title,
                owner: document.getElementById('inp-owner').value,
                weight: parseFloat(document.getElementById('inp-weight').value) || 1,
                startDate: document.getElementById('inp-start').value,
                endDate: document.getElementById('inp-end').value,
                tags: document.getElementById('inp-tags').value.split(',').map(s=>s.trim()).filter(Boolean)
            };

            // MODO EDICIÓN
            if (id) {
                const numId = parseInt(id);
                let collection = type === 'objective' ? db.objectives : type === 'project' ? db.projects : db.kpis;
                const idx = collection.findIndex(x => x.id === numId);
                if (idx !== -1) {
                    collection[idx] = { ...collection[idx], ...commonData };
                    if(type === 'kpi') {
                        collection[idx].startValue = parseFloat(document.getElementById('inp-val-start').value);
                        collection[idx].targetValue = parseFloat(document.getElementById('inp-val-target').value);
                    }
                }
            } 
            // MODO CREACIÓN
            else {
                const parentId = parseInt(document.getElementById('parent-id').value);
                const context = document.getElementById('context-type').value;
                const newItem = { id: Date.now(), ...commonData };

                if (type === 'objective') {
                    db.objectives.push(newItem);
                } else if (type === 'project') {
                    newItem.objectiveId = parentId;
                    db.projects.push(newItem);
                } else if (type === 'kpi') {
                    newItem.startValue = parseFloat(document.getElementById('inp-val-start').value) || 0;
                    newItem.targetValue = parseFloat(document.getElementById('inp-val-target').value) || 100;
                    newItem.currentValue = newItem.startValue;
                    
                    if (context === 'objective') newItem.objectiveId = parentId;
                    else newItem.projectId = parentId;
                    
                    db.kpis.push(newItem);
                }
            }
            saveDb(); closeModal(); renderExplorer();
        }

        /* ----------------------------------------------------
           5. UTILIDADES, DASHBOARD & EXPORT
           ---------------------------------------------------- */
        function saveDb() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        
        function renderTags(tags) {
            if(!tags || !tags.length) return '';
            return tags.map(t => `<span class="text-[9px] bg-slate-50 text-slate-500 border px-1 rounded uppercase">${t}</span>`).join('');
        }

        function switchView(view) {
            document.getElementById('view-explorer').classList.toggle('hidden', view !== 'explorer');
            document.getElementById('view-dashboard').classList.toggle('hidden', view !== 'dashboard');
            
            const btnEx = document.getElementById('btn-explorer');
            const btnDb = document.getElementById('btn-dashboard');
            
            if(view === 'dashboard') {
                updateDashboard();
                btnDb.classList.add('bg-slate-800', 'text-white'); btnEx.classList.remove('bg-slate-800', 'text-white');
            } else {
                btnEx.classList.add('bg-slate-800', 'text-white'); btnDb.classList.remove('bg-slate-800', 'text-white');
            }
        }

        function updateDashboard() {
            let totalSum = 0; let totalCount = 0;
            let counts = { 'A Tiempo': 0, 'En Riesgo': 0, 'Retrasado': 0 };
            const tbody = document.getElementById('dash-table-body');
            tbody.innerHTML = '';

            db.objectives.forEach(obj => {
                const m = calculateMetrics(obj, 'objective');
                totalSum += m.actual; totalCount++;
                if (m.label in counts) counts[m.label]++;
                else counts['Retrasado']++; // Default fallback

                // Fila tabla
                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-4 py-3 font-medium text-slate-900">${obj.title}</td>
                        <td class="px-4 py-3">${obj.owner || '-'}</td>
                        <td class="px-4 py-3 text-center">${obj.weight || 1}</td>
                        <td class="px-4 py-3 text-right font-bold">${m.actual}%</td>
                        <td class="px-4 py-3 text-center"><span class="${m.css} px-2 py-1 rounded text-xs font-bold">${m.label}</span></td>
                    </tr>
                `;
            });

            const globalAvg = totalCount ? Math.round(totalSum / totalCount) : 0;
            document.getElementById('dash-total').innerText = globalAvg + '%';
            document.getElementById('dash-ontrack').innerText = counts['A Tiempo'];
            document.getElementById('dash-atrisk').innerText = counts['En Riesgo'];
            document.getElementById('dash-offtrack').innerText = counts['Retrasado'];

            // Chart
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['A Tiempo', 'En Riesgo', 'Retrasado'],
                    datasets: [{
                        data: [counts['A Tiempo'], counts['En Riesgo'], counts['Retrasado']],
                        backgroundColor: ['#10b981', '#fbbf24', '#f43f5e'], borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        function exportData() {
            const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = s; a.download = "okr_backup.json"; a.click();
        }

        // Init
        renderExplorer();
    </script>
</body>
</html>
